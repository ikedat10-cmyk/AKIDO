<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAREER QUEST - ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆRPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    #app-container {
      width: 100%;
      height: 100%;
      margin: 0 auto;
      max-width: 480px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 15px rgba(102, 126, 234, 0.5); }
      50% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @keyframes shatter {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.5) rotate(20deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0.3; transform: scale(0.8) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    }
    
    @keyframes attackForward {
      0% { transform: translateX(0) scale(1); }
      50% { transform: translateX(-30px) scale(1.15); }
      100% { transform: translateX(0) scale(1); }
    }
    
    @keyframes damaged {
      0% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(15px) rotate(5deg); }
      50% { transform: translateX(-15px) rotate(-5deg); }
      75% { transform: translateX(10px) rotate(3deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }
    
    .slide-up {
      animation: slideUp 0.6s ease-out;
    }
    
    .glow-effect {
      animation: glow 2s infinite;
    }
    
    .shake-effect {
      animation: shake 0.5s ease-out;
    }
    
    .attack-effect {
      animation: attackForward 0.4s ease-out;
    }
    
    .damage-effect {
      animation: damaged 0.6s ease-out;
    }
    
    .shatter-effect {
      animation: shatter 0.8s ease-out forwards;
    }
    
    .pulse-effect {
      animation: pulse 2s infinite;
    }
    
    .sparkle-effect {
      animation: sparkle 2s infinite;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .dialogue-box {
      background: rgba(22, 33, 62, 0.95);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    .skill-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .skill-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .skill-card.locked {
      opacity: 0.5;
      filter: grayscale(0.8);
    }
    
    .skill-tier-1 { border-left: 4px solid #10b981; }
    .skill-tier-2 { border-left: 4px solid #3b82f6; }
    .skill-tier-3 { border-left: 4px solid #8b5cf6; }
    .skill-tier-4 { border-left: 4px solid #f59e0b; }
    .skill-tier-5 { border-left: 4px solid #ef4444; }
    
    .choice-button {
      transition: all 0.2s ease;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .choice-button:hover:not(:disabled) {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    
    .choice-button:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .choice-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #skill-scroll-container::-webkit-scrollbar {
      display: none;
    }
    
    .skill-card-btn:active {
      transform: scale(0.95);
    }
    
    .skill-card-btn:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-container" class="h-full w-full overflow-hidden">
   <div id="app" class="h-full w-full relative"></div>
  </div>
  <script>
    const defaultConfig = {
      background_color: "#0f0f23",
      surface_color: "#16213e",
      text_color: "#eef1ff",
      primary_action_color: "#667eea",
      secondary_action_color: "#764ba2",
      font_family: "Noto Sans JP",
      font_size: 18,
      main_title: "CAREER QUEST",
      subtitle: "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆRPG",
      tagline: "å¯¾è©±ãŒä¸–ç•Œã‚’å¤‰ãˆã‚‹",
      start_button: "ã¯ã˜ã‚ã‚‹",
      choice_empathy: "å…±æ„Ÿã™ã‚‹",
      choice_insight: "å•ã„ã‚’æŠ•ã’ã‚‹",
      choice_reframe: "è¦–ç‚¹ã‚’å¤‰ãˆã‚‹"
    };

    // ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    const skillDatabase = {
      // Lv1-20: åˆç´šãƒ»åˆ†ææ”»æ’ƒæœŸ
      lifeline_slash: { id: 'lifeline_slash', name: 'ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³ãƒ»ã‚¹ãƒ©ãƒƒã‚·ãƒ¥', level: 1, tier: 1, type: 'empathy', icon: 'âš”ï¸', damage: 25, effect: 'å¼±ç‚¹å±æ€§ã‚’å¯è¦–åŒ–', description: 'éå»ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ–¬ã‚Šã€æ•µã®å¼±ç‚¹ã‚’æš´ã', soundType: 'attack' },
      will_burst: { id: 'will_burst', name: 'ã‚¦ã‚£ãƒ«ãƒ»ãƒãƒ¼ã‚¹ãƒˆ', level: 2, tier: 1, type: 'insight', icon: 'ğŸ’¥', damage: 20, effect: 'æ„æ¬²ãƒ€ãƒ¡ãƒ¼ã‚¸', description: 'æ„æ¬²ã®åŠ›ã§å°ãƒ€ãƒ¡ãƒ¼ã‚¸', soundType: 'magic' },
      can_shield: { id: 'can_shield', name: 'ã‚­ãƒ£ãƒ³ãƒ»ã‚·ãƒ¼ãƒ«ãƒ‰', level: 3, tier: 1, type: 'empathy', icon: 'ğŸ›¡ï¸', damage: 0, effect: 'è‡ªä¿¡ãƒãƒªã‚¢å±•é–‹', description: 'æ¬¡ã‚¿ãƒ¼ãƒ³ã®ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›', soundType: 'defense' },
      must_pressure: { id: 'must_pressure', name: 'ãƒã‚¹ãƒˆãƒ»ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼', level: 4, tier: 1, type: 'insight', icon: 'âš¡', damage: 30, effect: 'ç¾©å‹™ä¾å­˜ã®æ•µã«è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸', description: 'ã€Œã€œã™ã¹ãã€æ€è€ƒã‚’æ’ƒã¤', soundType: 'attack' },
      wcm_triple: { id: 'wcm_triple', name: 'WCMä¸‰é€£æ’ƒ', level: 5, tier: 1, type: 'reframe', icon: 'ğŸ¯', damage: 45, effect: 'ãƒãƒ©ãƒ³ã‚¹å‹3é€£ç¶šæ”»æ’ƒ', description: 'Will-Can-Must ã‚’çµ±åˆ', soundType: 'attack' },
      
      resume_shield: { id: 'resume_shield', name: 'å±¥æ­´æ›¸ã‚·ãƒ¼ãƒ«ãƒ‰', level: 6, tier: 1, type: 'empathy', icon: 'ğŸ“„', damage: 0, effect: 'ä»–è€…è©•ä¾¡ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›', description: 'å®Ÿç¸¾ã§è‡ªå·±ã‚’å®ˆã‚‹', soundType: 'defense' },
      intro_strike: { id: 'intro_strike', name: 'è‡ªå·±ç´¹ä»‹ã®å…ˆåˆ¶æ”»æ’ƒ', level: 7, tier: 1, type: 'insight', icon: 'ğŸ‘‹', damage: 35, effect: 'åˆæœŸãƒãƒ•ç²å¾—', description: 'å¯¾è©±ã®ä¸»å°æ¨©ã‚’æ¡ã‚‹', soundType: 'attack' },
      listening_stance: { id: 'listening_stance', name: 'å‚¾è´ã®æ§‹ãˆ', level: 8, tier: 1, type: 'empathy', icon: 'ğŸ‘‚', damage: 0, effect: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç‡ä¸Šæ˜‡', description: 'ç›¸æ‰‹ã®è¨€è‘‰ã‚’å—ã‘æ­¢ã‚ã‚‹', soundType: 'defense' },
      question_arrow: { id: 'question_arrow', name: 'è³ªå•ã®çŸ¢', level: 9, tier: 1, type: 'insight', icon: 'ğŸ¹', damage: 28, effect: 'æ€è€ƒãƒ­ãƒƒã‚¯è§£é™¤', description: 'å•ã„ã§å›ºå®šè¦³å¿µã‚’ç •ã', soundType: 'attack' },
      deep_drill: { id: 'deep_drill', name: 'æ·±æ˜ã‚Šãƒ‰ãƒªãƒ«', level: 10, tier: 1, type: 'insight', icon: 'ğŸ”¨', damage: 40, effect: 'å¼±ç‚¹å€ç‡UP', description: 'æ ¸å¿ƒã¾ã§æ˜ã‚Šä¸‹ã’ã‚‹', soundType: 'attack' },
      
      career_anchor: { id: 'career_anchor', name: 'ã‚­ãƒ£ãƒªã‚¢ãƒ»ã‚¢ãƒ³ã‚«ãƒ¼', level: 11, tier: 1, type: 'reframe', icon: 'âš“', damage: 30, effect: 'è¡Œå‹•ä¸èƒ½ä»˜ä¸', description: 'ä¾¡å€¤è¦³ã®éŒ¨ã§æ•µã‚’å›ºå®š', soundType: 'magic' },
      value_sort: { id: 'value_sort', name: 'ä¾¡å€¤è¦³ã®é¸åˆ¥', level: 12, tier: 1, type: 'reframe', icon: 'ğŸ´', damage: 35, effect: 'ãƒãƒ•è§£é™¤', description: 'å„ªå…ˆé †ä½ã‚’æ•´ç†ã™ã‚‹', soundType: 'magic' },
      job_card_log: { id: 'job_card_log', name: 'ã‚¸ãƒ§ãƒ–ãƒ»ã‚«ãƒ¼ãƒ‰è¨˜éŒ²', level: 13, tier: 1, type: 'insight', icon: 'ğŸ“', damage: 25, effect: 'ãƒ­ã‚°ç²å¾—ï¼ˆåˆ†æç²¾åº¦UPï¼‰', description: 'çµŒé¨“ã‚’è¨˜éŒ²ã—å¯è¦–åŒ–', soundType: 'magic' },
      skillset_check: { id: 'skillset_check', name: 'ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆç‚¹æ¤œ', level: 14, tier: 1, type: 'insight', icon: 'ğŸ”', damage: 30, effect: 'æ”»æ’ƒåŠ›å†è¨ˆç®—', description: 'æŒã¦ã‚‹ã‚¹ã‚­ãƒ«ã‚’æ£šå¸ã—', soundType: 'magic' },
      interest_spark: { id: 'interest_spark', name: 'èˆˆå‘³é–¢å¿ƒã®ç«ç¨®', level: 15, tier: 1, type: 'empathy', icon: 'ğŸ”¥', damage: 50, effect: 'ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸', description: 'æƒ…ç†±ãŒå¾ã€…ã«ç‡ƒãˆåºƒãŒã‚‹', soundType: 'magic' },
      
      strength_excavate: { id: 'strength_excavate', name: 'å¼·ã¿ã®ç™ºæ˜', level: 16, tier: 1, type: 'empathy', icon: 'â›ï¸', damage: 35, effect: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡UP', description: 'éš ã‚ŒãŸæ‰èƒ½ã‚’æ˜ã‚Šèµ·ã“ã™', soundType: 'attack' },
      weakness_transform: { id: 'weakness_transform', name: 'çŸ­æ‰€ã®è»¢æ›', level: 17, tier: 1, type: 'reframe', icon: 'ğŸ”„', damage: 40, effect: 'ãƒ‡ãƒãƒ•åè»¢', description: 'å¼±ã¿ã‚’å¼·ã¿ã«è»¢æ›ã™ã‚‹', soundType: 'magic' },
      success_wave: { id: 'success_wave', name: 'æˆåŠŸä½“é¨“ã®æ³¢å‹•', level: 18, tier: 1, type: 'empathy', icon: 'ğŸŒŠ', damage: 30, effect: 'å…¨ä½“å›å¾©', description: 'éå»ã®æˆåŠŸãŒå‹‡æ°—ã‚’ä¸ãˆã‚‹', soundType: 'defense' },
      failure_nourish: { id: 'failure_nourish', name: 'å¤±æ•—ã®ç³§', level: 19, tier: 1, type: 'reframe', icon: 'ğŸŒ±', damage: 25, effect: 'HPå›å¾©ï¼‹è€æ€§UP', description: 'å¤±æ•—ã‹ã‚‰å­¦ã³æˆé•·ã™ã‚‹', soundType: 'defense' },
      origin_return: { id: 'origin_return', name: 'åˆå¿ƒå¿˜ã‚‹ã¹ã‹ã‚‰ãš', level: 20, tier: 1, type: 'empathy', icon: 'ğŸ', damage: 45, effect: 'åŸç‚¹å›å¸°ãƒ€ãƒ¡ãƒ¼ã‚¸', description: 'åŸç‚¹ã«æˆ»ã‚ŠåŠ›ã‚’å–ã‚Šæˆ»ã™', soundType: 'magic' }
    };

    let playerData = null;
    let currentEnemy = null;
    let currentScene = 'title';
    let battleState = {
      enemyHp: 100,
      enemyMaxHp: 100,
      anxiety: 50,
      hope: 50,
      turn: 0,
      messages: [],
      shield: 0,
      counter: false
    };
    let isProcessing = false;
    let isRendering = false;

    const enemies = {
      anxiety: {
        id: 'anxiety',
        name: "ä¸å®‰ã®åŒ–èº«",
        catchphrase: "æœªæ¥ã¸ã®æã‚ŒãŒå½¢ã‚’æŒã£ã¦ç¾ã‚ŒãŸ",
        maxHp: 120,
        weakness: "empathy",
        dialogue: {
          intro: "ã€Œå›ã«ä½•ãŒã§ãã‚‹ï¼Ÿ å¤±æ•—ã™ã‚‹ã®æ±ºã¾ã£ã¦ã‚‹ã€",
          attack: "ã€Œå‘¨ã‚Šã®æœŸå¾…ã«å¿œãˆã‚‰ã‚Œãªã„ã€",
          weak: "ã€Œã§ã‚‚... ä¸å®‰ã¯æ‚ªã„ã“ã¨ã§...ã€",
          defeat: "ã€Œä¸å®‰ã¨ã¯ã€å¯èƒ½æ€§ã¸ã®æ‰‰ã ã£ãŸã€"
        },
        background: "linear-gradient(180deg, #0f0f23 0%, #1a1a3e 100%)"
      },
      overwork: {
        id: 'overwork',
        name: "é‡åŠ´åƒã®å·¨äºº",
        catchphrase: "çµ‚ã‚ã‚ŠãªãåŠ´åƒãŒç«‹ã¡ã¯ã ã‹ã‚‹",
        maxHp: 150,
        weakness: "insight",
        dialogue: {
          intro: "ã€Œä¼‘ã‚€ãªã€‚æ­¢ã¾ã‚‹ãªã€‚åƒãç¶šã‘ã‚ã€",
          attack: "ã€ŒãŠå‰ã®æ™‚é–“ã‚‚äººç”Ÿã‚‚ã€å…¨ã¦ä»•äº‹ã®ã‚‚ã®ã ã€",
          weak: "ã€ŒåŠ´åƒåŸºæº–... ãã‚“ãªã‚‚ã®...ã€",
          defeat: "ã€Œåƒãã¨ã¯... äººé–“ã®ãŸã‚ã®ã‚‚ã®...ã€"
        },
        background: "linear-gradient(180deg, #1a1a2e 0%, #2d2d44 100%)"
      },
      selfDoubt: {
        id: 'selfDoubt',
        name: "è‡ªå·±å¦å®šã®å£°",
        catchphrase: "å†…ãªã‚‹æ‰¹åˆ¤è€…ãŒç›®ã‚’è¦šã¾ã™",
        maxHp: 100,
        weakness: "reframe",
        dialogue: {
          intro: "ã€ŒãŠå‰ã«ã¯ä¾¡å€¤ãŒãªã„ã€‚æ‰èƒ½ã‚‚ãªã„ã€",
          attack: "ã€Œèª°ã‚‚ãŠå‰ã‚’èªã‚ãªã„ã€",
          weak: "ã€Œãã†... è©•ä¾¡è»¸ã¯ä¸€ã¤ã˜ã‚ƒ...ã€",
          defeat: "ã€Œä¾¡å€¤ã¨ã¯ã€è‡ªåˆ†ã§æ±ºã‚ã‚‹ã‚‚ã®ã ã£ãŸã€"
        },
        background: "linear-gradient(180deg, #1a1a2e 0%, #2d2d44 100%)"
      },
      burnout: {
        id: 'burnout',
        name: "ç‡ƒãˆå°½ããŸç‚",
        catchphrase: "æƒ…ç†±ãŒç°ã¨ãªã‚Šç«‹ã¡ä¸ŠãŒã‚‹",
        maxHp: 110,
        weakness: "empathy",
        dialogue: {
          intro: "ã€Œã‚‚ã†ä½•ã‚‚æ„Ÿã˜ãªã„ã€‚ä½•ã‚‚å‹•ã‘ãªã„ã€",
          attack: "ã€Œé ‘å¼µã‚‹æ„å‘³ãªã‚“ã¦ãªã‹ã£ãŸã€",
          weak: "ã€Œã§ã‚‚... ã¾ã å°ã•ãªç«ç¨®ãŒ...ã€",
          defeat: "ã€Œæƒ…ç†±ã¯... ã¾ãŸç‡ƒã‚„ã›ã‚‹ã‚‚ã®...ã€"
        },
        background: "linear-gradient(180deg, #2d1b1e 0%, #1a1a2e 100%)"
      },
      conformity: {
        id: 'conformity',
        name: "åŒèª¿åœ§åŠ›ã®ç¾¤ã‚Œ",
        catchphrase: "ç„¡æ•°ã®å£°ãŒä¸€ã¤ã«æº¶ã‘åˆã†",
        maxHp: 130,
        weakness: "reframe",
        dialogue: {
          intro: "ã€Œã¿ã‚“ãªãã†ã—ã¦ã‚‹ã€‚ãŠå‰ã ã‘é•ã†ã®ï¼Ÿã€",
          attack: "ã€Œç©ºæ°—èª­ã‚ã‚ˆã€‚å”èª¿æ€§ãªã„ãªã€",
          weak: "ã€Œã§ã‚‚... å€‹æ€§ã£ã¦...ã€",
          defeat: "ã€Œå¤šæ§˜æ€§ã“ããŒ... åŠ›ã ã£ãŸ...ã€"
        },
        background: "linear-gradient(180deg, #1a1a2e 0%, #2d2244 100%)"
      },
      judgment: {
        id: 'judgment',
        name: "è£ãã®å¤©ç§¤",
        catchphrase: "è©•ä¾¡ã¨æŸ»å®šã®åŒ–èº«ãŒå›è‡¨ã™ã‚‹",
        maxHp: 140,
        weakness: "insight",
        dialogue: {
          intro: "ã€ŒãŠå‰ã®ä¾¡å€¤ã‚’æ¸¬å®šã™ã‚‹ã€‚åˆæ ¼ç‚¹ã«ã¯å±Šã‹ãªã„ã€",
          attack: "ã€Œè©•ä¾¡Dã€‚èƒ½åŠ›ä¸è¶³ã€",
          weak: "ã€Œæ•°å€¤åŒ–ã§ããªã„ã‚‚ã®ãŒ...ã€",
          defeat: "ã€Œäººã®ä¾¡å€¤ã¯... ç‚¹æ•°ã˜ã‚ƒãªã„...ã€"
        },
        background: "linear-gradient(180deg, #2d1b1e 0%, #1a2332 100%)"
      },
      maze: {
        id: 'maze',
        name: "è¿·å®®ã®ç•ªäºº",
        catchphrase: "ç„¡é™ã®é¸æŠè‚¢ãŒé“ã‚’å¡ã",
        maxHp: 125,
        weakness: "insight",
        dialogue: {
          intro: "ã€Œã©ã®é“ã‚’é¸ã¶ï¼Ÿ å…¨ã¦è¡Œãæ­¢ã¾ã‚Šã ãŒã€",
          attack: "ã€Œæ­£è§£ã¯ãªã„ã€‚æ°¸é ã«è¿·ã„ç¶šã‘ã‚ã€",
          weak: "ã€Œé“ã¯... è‡ªåˆ†ã§ä½œã‚Œã‚‹...ã€",
          defeat: "ã€Œè¿·ã†ã“ã¨ã‚‚... ä¸€ã¤ã®ç­”ãˆ...ã€"
        },
        background: "linear-gradient(180deg, #1a2e1a 0%, #1a1a2e 100%)"
      },
      ideal: {
        id: 'ideal',
        name: "ç†æƒ³ã¨ç¾å®Ÿã®äº€è£‚",
        catchphrase: "è¼ãå¤¢ã¨å´©ã‚Œã‚‹ç¾å®ŸãŒäº¤éŒ¯ã™ã‚‹",
        maxHp: 115,
        weakness: "reframe",
        dialogue: {
          intro: "ã€Œç†æƒ³ã¯ç¾ã—ã„ã€‚ã ãŒç¾å®Ÿã¯é†œã„ã€",
          attack: "ã€Œå¤¢è¦‹ãŸæœªæ¥ã¯å¹»æƒ³ã ã£ãŸã€",
          weak: "ã€Œã§ã‚‚... ç†æƒ³ã¨ç¾å®Ÿã¯...ã€",
          defeat: "ã€Œä¸¡æ–¹ã‚ã£ã¦... äººã¯é€²ã‚ã‚‹...ã€"
        },
        background: "linear-gradient(180deg, #2d2244 0%, #1a1a2e 100%)"
      },
      role: {
        id: 'role',
        name: "å½¹å‰²ã®é§",
        catchphrase: "è‚©æ›¸ãã¨è²¬ä»»ãŒé‡ãåœ§ã—æ›ã‹ã‚‹",
        maxHp: 135,
        weakness: "empathy",
        dialogue: {
          intro: "ã€ŒãŠå‰ã¯ã€‡ã€‡ã§ã‚ã‚‹ã¹ãã ã€‚ãã‚Œä»¥å¤–ã¯è¨±ã•ã‚Œãªã„ã€",
          attack: "ã€Œå½¹å‰²ã‚’æœãŸã›ã€‚æœŸå¾…ã«å¿œãˆã‚ã€",
          weak: "ã€Œã§ã‚‚... å½¹å‰²ã®ä¸‹ã«ã¯...ã€",
          defeat: "ã€Œäººã¯... å½¹å‰²ã ã‘ã˜ã‚ƒãªã„...ã€"
        },
        background: "linear-gradient(180deg, #1a2332 0%, #2d2d44 100%)"
      },
      void: {
        id: 'void',
        name: "è™šç„¡ã®æ·±æ·µ",
        catchphrase: "æ„å‘³ã®å–ªå¤±ãŒæš—é—‡ã‚’å‘¼ã¶",
        maxHp: 145,
        weakness: "empathy",
        dialogue: {
          intro: "ã€Œå…¨ã¦ãŒç„¡æ„å‘³ã€‚ä½•ã‚’ã—ã¦ã‚‚åŒã˜ã€",
          attack: "ã€Œå­˜åœ¨ã™ã‚‹æ„å‘³ãªã©ã€ãªã„ã€",
          weak: "ã€Œã§ã‚‚... å°ã•ãªæ„å‘³ãŒ...ã€",
          defeat: "ã€Œæ„å‘³ã¯... è‡ªåˆ†ã§è¦‹ã¤ã‘ã‚‹ã‚‚ã®...ã€"
        },
        background: "linear-gradient(180deg, #0f0f23 0%, #1a1a3e 100%)"
      }
    };

    // ğŸµ ã‚µã‚¦ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
    
    let bgmContext = null;
    let currentBgm = null;
    let bgmGainNode = null;
    let bgmEnabled = true;
    let bgmVolume = 0.3;
    
    // BGMåˆ¶å¾¡
    function stopBgm() {
      if (currentBgm) {
        try {
          currentBgm.stop();
        } catch(e) {}
        currentBgm = null;
      }
    }
    
    function setBgmVolume(volume) {
      bgmVolume = Math.max(0, Math.min(1, volume));
      if (bgmGainNode) {
        bgmGainNode.gain.setValueAtTime(bgmVolume, bgmContext.currentTime);
      }
    }
    
    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢BGM - å£®å¤§ã§å¸Œæœ›ã«æº€ã¡ãŸæ—‹å¾‹
    function playTitleBgm() {
      if (!bgmEnabled) return;
      stopBgm();
      
      bgmContext = new (window.AudioContext || window.webkitAudioContext)();
      bgmGainNode = bgmContext.createGain();
      bgmGainNode.gain.setValueAtTime(bgmVolume, bgmContext.currentTime);
      bgmGainNode.connect(bgmContext.destination);
      
      const now = bgmContext.currentTime;
      const tempo = 0.5; // ã‚†ã£ãŸã‚Šã¨ã—ãŸãƒ†ãƒ³ãƒ
      
      // ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ©ã‚¤ãƒ³: C Major ã‚¹ã‚±ãƒ¼ãƒ«ã§å¸Œæœ›çš„ãªæ—‹å¾‹
      const melody = [
        {note: 523.25, start: 0, duration: tempo}, // C5
        {note: 587.33, start: tempo, duration: tempo}, // D5
        {note: 659.25, start: tempo * 2, duration: tempo}, // E5
        {note: 783.99, start: tempo * 3, duration: tempo * 2}, // G5
        {note: 659.25, start: tempo * 5, duration: tempo}, // E5
        {note: 587.33, start: tempo * 6, duration: tempo}, // D5
        {note: 523.25, start: tempo * 7, duration: tempo * 2}, // C5
      ];
      
      melody.forEach(({note, start, duration}) => {
        const osc = bgmContext.createOscillator();
        const oscGain = bgmContext.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(note, now + start);
        oscGain.gain.setValueAtTime(0, now + start);
        oscGain.gain.linearRampToValueAtTime(0.15, now + start + 0.05);
        oscGain.gain.linearRampToValueAtTime(0, now + start + duration);
        osc.connect(oscGain);
        oscGain.connect(bgmGainNode);
        osc.start(now + start);
        osc.stop(now + start + duration);
      });
      
      // ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼: æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰é€²è¡Œ
      const chords = [
        {notes: [261.63, 329.63, 392.00], start: 0, duration: tempo * 2}, // C major
        {notes: [293.66, 369.99, 440.00], start: tempo * 2, duration: tempo * 2}, // D minor
        {notes: [329.63, 392.00, 493.88], start: tempo * 4, duration: tempo * 2}, // E minor
        {notes: [261.63, 329.63, 392.00], start: tempo * 6, duration: tempo * 3}, // C major
      ];
      
      chords.forEach(({notes, start, duration}) => {
        notes.forEach(note => {
          const osc = bgmContext.createOscillator();
          const oscGain = bgmContext.createGain();
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(note, now + start);
          oscGain.gain.setValueAtTime(0, now + start);
          oscGain.gain.linearRampToValueAtTime(0.08, now + start + 0.1);
          oscGain.gain.setValueAtTime(0.08, now + start + duration - 0.2);
          oscGain.gain.linearRampToValueAtTime(0, now + start + duration);
          osc.connect(oscGain);
          oscGain.connect(bgmGainNode);
          osc.start(now + start);
          osc.stop(now + start + duration);
        });
      });
      
      // ãƒ«ãƒ¼ãƒ—è¨­å®š
      setTimeout(() => {
        if (currentScene === 'title' && bgmEnabled) {
          playTitleBgm();
        }
      }, tempo * 9 * 1000);
      
      currentBgm = { context: bgmContext };
    }
    
    // ãƒãƒˆãƒ«BGM - ç·Šå¼µæ„Ÿã®ã‚ã‚‹ãƒªã‚ºãƒŸã‚«ãƒ«ãªæ—‹å¾‹
    function playBattleBgm() {
      if (!bgmEnabled) return;
      stopBgm();
      
      bgmContext = new (window.AudioContext || window.webkitAudioContext)();
      bgmGainNode = bgmContext.createGain();
      bgmGainNode.gain.setValueAtTime(bgmVolume, bgmContext.currentTime);
      bgmGainNode.connect(bgmContext.destination);
      
      const now = bgmContext.currentTime;
      const tempo = 0.25; // é€Ÿã„ãƒ†ãƒ³ãƒ
      
      // ãƒ¡ã‚¤ãƒ³ãƒªãƒ•: A minor ã‚¹ã‚±ãƒ¼ãƒ«ã§ç·Šå¼µæ„Ÿ
      const battleRiff = [
        {note: 440.00, start: 0, duration: tempo * 0.8}, // A4
        {note: 493.88, start: tempo, duration: tempo * 0.8}, // B4
        {note: 523.25, start: tempo * 2, duration: tempo * 0.8}, // C5
        {note: 587.33, start: tempo * 3, duration: tempo * 0.8}, // D5
        {note: 523.25, start: tempo * 4, duration: tempo * 0.8}, // C5
        {note: 493.88, start: tempo * 5, duration: tempo * 0.8}, // B4
        {note: 440.00, start: tempo * 6, duration: tempo * 1.5}, // A4
      ];
      
      battleRiff.forEach(({note, start, duration}) => {
        const osc = bgmContext.createOscillator();
        const oscGain = bgmContext.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(note, now + start);
        oscGain.gain.setValueAtTime(0, now + start);
        oscGain.gain.linearRampToValueAtTime(0.12, now + start + 0.01);
        oscGain.gain.linearRampToValueAtTime(0, now + start + duration);
        osc.connect(oscGain);
        oscGain.connect(bgmGainNode);
        osc.start(now + start);
        osc.stop(now + start + duration);
      });
      
      // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
      const bassLine = [
        {note: 110.00, start: 0, duration: tempo * 2}, // A2
        {note: 130.81, start: tempo * 2, duration: tempo * 2}, // C3
        {note: 146.83, start: tempo * 4, duration: tempo * 2}, // D3
        {note: 110.00, start: tempo * 6, duration: tempo * 2}, // A2
      ];
      
      bassLine.forEach(({note, start, duration}) => {
        const osc = bgmContext.createOscillator();
        const oscGain = bgmContext.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(note, now + start);
        oscGain.gain.setValueAtTime(0.15, now + start);
        oscGain.gain.setValueAtTime(0.15, now + start + duration - 0.05);
        oscGain.gain.linearRampToValueAtTime(0, now + start + duration);
        osc.connect(oscGain);
        oscGain.connect(bgmGainNode);
        osc.start(now + start);
        osc.stop(now + start + duration);
      });
      
      // ãƒ«ãƒ¼ãƒ—è¨­å®š
      setTimeout(() => {
        if ((currentScene === 'battle' || currentScene === 'battle-intro') && bgmEnabled) {
          playBattleBgm();
        }
      }, tempo * 8 * 1000);
      
      currentBgm = { context: bgmContext };
    }
    
    // å‹åˆ©BGM - æ˜ã‚‹ãè¯ã‚„ã‹ãªãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
    function playVictoryBgm() {
      if (!bgmEnabled) return;
      stopBgm();
      
      bgmContext = new (window.AudioContext || window.webkitAudioContext)();
      bgmGainNode = bgmContext.createGain();
      bgmGainNode.gain.setValueAtTime(bgmVolume, bgmContext.currentTime);
      bgmGainNode.connect(bgmContext.destination);
      
      const now = bgmContext.currentTime;
      
      // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬æ—‹å¾‹
      const fanfare = [
        {note: 523.25, start: 0, duration: 0.3}, // C5
        {note: 659.25, start: 0.3, duration: 0.3}, // E5
        {note: 783.99, start: 0.6, duration: 0.3}, // G5
        {note: 1046.50, start: 0.9, duration: 0.6}, // C6
        {note: 783.99, start: 1.6, duration: 0.2}, // G5
        {note: 1046.50, start: 1.8, duration: 0.8}, // C6
      ];
      
      fanfare.forEach(({note, start, duration}) => {
        const osc = bgmContext.createOscillator();
        const oscGain = bgmContext.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(note, now + start);
        oscGain.gain.setValueAtTime(0, now + start);
        oscGain.gain.linearRampToValueAtTime(0.2, now + start + 0.02);
        oscGain.gain.linearRampToValueAtTime(0, now + start + duration);
        osc.connect(oscGain);
        oscGain.connect(bgmGainNode);
        osc.start(now + start);
        osc.stop(now + start + duration);
      });
      
      // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      for (let i = 0; i < 8; i++) {
        const osc = bgmContext.createOscillator();
        const oscGain = bgmContext.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1000 + Math.random() * 1000, now + i * 0.15);
        oscGain.gain.setValueAtTime(0, now + i * 0.15);
        oscGain.gain.linearRampToValueAtTime(0.1, now + i * 0.15 + 0.01);
        oscGain.gain.linearRampToValueAtTime(0, now + i * 0.15 + 0.3);
        osc.connect(oscGain);
        oscGain.connect(bgmGainNode);
        osc.start(now + i * 0.15);
        osc.stop(now + i * 0.15 + 0.3);
      }
      
      currentBgm = { context: bgmContext };
    }
    
    // æ”»æ’ƒåŠ¹æœéŸ³ï¼ˆç‰©ç†ç³»ã‚¹ã‚­ãƒ«ï¼‰
    function playAttackSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        // æ–¬æ’ƒéŸ³ï¼šé‹­ã„é«˜éŸ³ã‹ã‚‰ä½éŸ³ã¸ã®æ€¥é™ä¸‹
        const slashOsc = audioContext.createOscillator();
        const slashGain = audioContext.createGain();
        slashOsc.type = 'sawtooth';
        slashOsc.frequency.setValueAtTime(1200, now);
        slashOsc.frequency.exponentialRampToValueAtTime(200, now + 0.08);
        slashGain.gain.setValueAtTime(0.4, now);
        slashGain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
        slashOsc.connect(slashGain);
        slashGain.connect(audioContext.destination);
        slashOsc.start(now);
        slashOsc.stop(now + 0.08);
        
        // è¡æ’ƒéŸ³ï¼šä½éŸ³ãƒ‘ãƒ³ãƒ
        const impactOsc = audioContext.createOscillator();
        const impactGain = audioContext.createGain();
        impactOsc.type = 'sine';
        impactOsc.frequency.setValueAtTime(80, now + 0.05);
        impactGain.gain.setValueAtTime(0.5, now + 0.05);
        impactGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        impactOsc.connect(impactGain);
        impactGain.connect(audioContext.destination);
        impactOsc.start(now + 0.05);
        impactOsc.stop(now + 0.2);
      } catch (e) {
        console.warn('Audio playback failed:', e);
      }
    }

    // é­”æ³•åŠ¹æœéŸ³ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ç³»ã‚¹ã‚­ãƒ«ï¼‰
    function playMagicSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        // ã‚­ãƒ©ã‚­ãƒ©ä¸Šæ˜‡éŸ³
        const magic1 = audioContext.createOscillator();
        const magic1Gain = audioContext.createGain();
        magic1.type = 'sine';
        magic1.frequency.setValueAtTime(523.25, now); // C5
        magic1.frequency.linearRampToValueAtTime(783.99, now + 0.15); // G5
        magic1Gain.gain.setValueAtTime(0.2, now);
        magic1Gain.gain.linearRampToValueAtTime(0, now + 0.15);
        magic1.connect(magic1Gain);
        magic1Gain.connect(audioContext.destination);
        magic1.start(now);
        magic1.stop(now + 0.15);
        
        const magic2 = audioContext.createOscillator();
        const magic2Gain = audioContext.createGain();
        magic2.type = 'sine';
        magic2.frequency.setValueAtTime(659.25, now + 0.05); // E5
        magic2.frequency.linearRampToValueAtTime(1046.50, now + 0.2); // C6
        magic2Gain.gain.setValueAtTime(0.2, now + 0.05);
        magic2Gain.gain.linearRampToValueAtTime(0, now + 0.2);
        magic2.connect(magic2Gain);
        magic2Gain.connect(audioContext.destination);
        magic2.start(now + 0.05);
        magic2.stop(now + 0.2);
        
        // ã‚¨ãƒãƒ«ã‚®ãƒ¼æŒç¶šéŸ³
        const energyOsc = audioContext.createOscillator();
        const energyGain = audioContext.createGain();
        energyOsc.type = 'triangle';
        energyOsc.frequency.setValueAtTime(880, now);
        energyOsc.frequency.linearRampToValueAtTime(1320, now + 0.3);
        energyGain.gain.setValueAtTime(0.15, now);
        energyGain.gain.linearRampToValueAtTime(0, now + 0.3);
        energyOsc.connect(energyGain);
        energyGain.connect(audioContext.destination);
        energyOsc.start(now);
        energyOsc.stop(now + 0.3);
      } catch (e) {
        console.warn('Audio playback failed:', e);
      }
    }

    // é˜²å¾¡ãƒ»å›å¾©åŠ¹æœéŸ³ï¼ˆã‚·ãƒ¼ãƒ«ãƒ‰ç³»ã‚¹ã‚­ãƒ«ï¼‰
    function playDefenseSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        // ã‚·ãƒ¼ãƒ«ãƒ‰å±•é–‹éŸ³ï¼šä½éŸ³ã‹ã‚‰é«˜éŸ³ã¸
        const shield1 = audioContext.createOscillator();
        const shield1Gain = audioContext.createGain();
        shield1.type = 'sine';
        shield1.frequency.setValueAtTime(200, now);
        shield1.frequency.linearRampToValueAtTime(600, now + 0.2);
        shield1Gain.gain.setValueAtTime(0.3, now);
        shield1Gain.gain.linearRampToValueAtTime(0, now + 0.2);
        shield1.connect(shield1Gain);
        shield1Gain.connect(audioContext.destination);
        shield1.start(now);
        shield1.stop(now + 0.2);
        
        // ã‚­ãƒ¼ãƒ³éŸ³ï¼šé«˜éŸ³æŒç¶š
        const shield2 = audioContext.createOscillator();
        const shield2Gain = audioContext.createGain();
        shield2.type = 'sine';
        shield2.frequency.setValueAtTime(1200, now + 0.15);
        shield2Gain.gain.setValueAtTime(0.2, now + 0.15);
        shield2Gain.gain.linearRampToValueAtTime(0, now + 0.5);
        shield2.connect(shield2Gain);
        shield2Gain.connect(audioContext.destination);
        shield2.start(now + 0.15);
        shield2.stop(now + 0.5);
        
        // ãƒãƒªã‚¢å…±é³´éŸ³
        const resonance = audioContext.createOscillator();
        const resonanceGain = audioContext.createGain();
        resonance.type = 'triangle';
        resonance.frequency.setValueAtTime(800, now + 0.1);
        resonanceGain.gain.setValueAtTime(0.15, now + 0.1);
        resonanceGain.gain.linearRampToValueAtTime(0, now + 0.4);
        resonance.connect(resonanceGain);
        resonanceGain.connect(audioContext.destination);
        resonance.start(now + 0.1);
        resonance.stop(now + 0.4);
      } catch (e) {
        console.warn('Audio playback failed:', e);
      }
    }

    // æ’ƒç ´åŠ¹æœéŸ³ï¼ˆãƒœã‚¹æ’ƒç ´æ™‚ã®é‡åšãªã‚µã‚¦ãƒ³ãƒ‰ï¼‰
    function playDefeatSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        // é‡ä½éŸ³
        const bassOsc = audioContext.createOscillator();
        const bassGain = audioContext.createGain();
        bassOsc.type = 'sine';
        bassOsc.frequency.setValueAtTime(65.41, now);
        bassGain.gain.setValueAtTime(0, now);
        bassGain.gain.linearRampToValueAtTime(0.3, now + 0.2);
        bassGain.gain.linearRampToValueAtTime(0.21, now + 1.7);
        bassGain.gain.linearRampToValueAtTime(0, now + 3.2);
        bassOsc.connect(bassGain);
        bassGain.connect(audioContext.destination);
        bassOsc.start(now);
        bassOsc.stop(now + 3.2);
        
        // å´©å£Šãƒã‚¤ã‚º
        const bufferSize = audioContext.sampleRate * 2.5;
        const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          output[i] = (lastOut + (0.02 * white)) / 1.02;
          lastOut = output[i];
          output[i] *= 3.5;
        }
        
        const noiseSource = audioContext.createBufferSource();
        noiseSource.buffer = noiseBuffer;
        const noiseFilter = audioContext.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.value = 500;
        const noiseGain = audioContext.createGain();
        noiseGain.gain.setValueAtTime(0, now);
        noiseGain.gain.linearRampToValueAtTime(0.15, now + 0.1);
        noiseGain.gain.linearRampToValueAtTime(0.05, now + 1.3);
        noiseGain.gain.linearRampToValueAtTime(0, now + 2.3);
        noiseSource.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noiseGain.connect(audioContext.destination);
        noiseSource.start(now);
        
        // ä¸‹é™éŸ³
        const fallOsc = audioContext.createOscillator();
        const fallGain = audioContext.createGain();
        fallOsc.type = 'sawtooth';
        fallOsc.frequency.setValueAtTime(146.83, now);
        fallOsc.frequency.exponentialRampToValueAtTime(55, now + 2.5);
        fallGain.gain.setValueAtTime(0, now);
        fallGain.gain.linearRampToValueAtTime(0.15, now + 0.1);
        fallGain.gain.linearRampToValueAtTime(0, now + 2.5);
        fallOsc.connect(fallGain);
        fallGain.connect(audioContext.destination);
        fallOsc.start(now);
        fallOsc.stop(now + 2.5);
      } catch (e) {
        console.warn('Audio playback failed:', e);
      }
    }

    const dataHandler = {
      onDataChanged(data) {
        if (data.length > 0) {
          playerData = data[0];
        }
      }
    };

    async function initializeSDKs() {
      const dataResult = await window.dataSdk.init(dataHandler);
      if (!dataResult.isOk) {
        console.error("Data SDK initialization failed");
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            renderCurrentScene();
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["main_title", config.main_title || defaultConfig.main_title],
            ["subtitle", config.subtitle || defaultConfig.subtitle],
            ["tagline", config.tagline || defaultConfig.tagline],
            ["start_button", config.start_button || defaultConfig.start_button],
            ["choice_empathy", config.choice_empathy || defaultConfig.choice_empathy],
            ["choice_insight", config.choice_insight || defaultConfig.choice_insight],
            ["choice_reframe", config.choice_reframe || defaultConfig.choice_reframe]
          ])
        });
      }
    }

    function getConfig() {
      return window.elementSdk?.config || defaultConfig;
    }

    function getUnlockedSkills() {
      if (!playerData) return [];
      const unlockedIds = (playerData.unlocked_skills || '').split(',').filter(s => s);
      return Object.values(skillDatabase)
        .filter(skill => skill.level <= playerData.player_level)
        .filter(skill => unlockedIds.includes(skill.type) || skill.level <= 10);
    }

    function getAvailableSkillsForBattle() {
      const allSkills = getUnlockedSkills();
      
      // å…¨ç¿’å¾—ã‚¹ã‚­ãƒ«ã‹ã‚‰æœ€å¤§8å€‹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
      const shuffled = [...allSkills].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(8, allSkills.length));
    }

    function renderCurrentScene() {
      if (isRendering) return;
      isRendering = true;
      
      const app = document.getElementById('app');
      const config = getConfig();
      
      try {
        switch(currentScene) {
          case 'title':
            renderTitleScreen(app, config);
            break;
          case 'character-creation':
            renderCharacterCreation(app, config);
            break;
          case 'story-intro':
            renderStoryIntro(app, config);
            break;
          case 'skill-tree':
            renderSkillTree(app, config);
            break;
          case 'battle-intro':
            renderBattleIntro(app, config);
            break;
          case 'battle':
            renderBattleScreen(app, config);
            break;
          case 'result':
            renderResultScreen(app, config);
            break;
          case 'emotion-log':
            renderEmotionLog(app, config);
            break;
          case 'ending':
            renderEnding(app, config);
            break;
          case 'save-load':
            renderSaveLoad(app, config);
            break;
        }
      } finally {
        isRendering = false;
      }
    }

    async function getAllSaveData() {
      // Data SDKã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€onDataChangedã§ä¿æŒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      let allData = [];
      
      const tempHandler = {
        onDataChanged(data) {
          allData = data;
        }
      };
      
      // æ—¢å­˜ã®handlerã‚’ä¸€æ™‚çš„ã«ä½¿ç”¨
      await window.dataSdk.init(tempHandler);
      
      return allData;
    }

    function renderSaveLoad(app, config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      
      // å…¨ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆplayerDataã®ä»–ã«ã‚‚è¤‡æ•°ã‚»ãƒ¼ãƒ–ãŒã‚ã‚‹å¯èƒ½æ€§ï¼‰
      const initPromise = getAllSaveData();
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto p-8 fade-in"
             style="background: ${config.background_color || defaultConfig.background_color};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="max-w-md mx-auto space-y-6">
            <div class="text-center mb-6">
              <h2 class="mb-2" style="font-size: ${baseSize * 2}px; font-weight: bold;">
                ğŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ç®¡ç†
              </h2>
              <p style="font-size: ${baseSize}px; opacity: 0.8;">
                ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†
              </p>
            </div>
            
            <div id="save-slots" class="space-y-4">
              <div class="text-center" style="font-size: ${baseSize}px;">
                èª­ã¿è¾¼ã¿ä¸­...
              </div>
            </div>
            
            <button id="back-to-title-btn" 
                    class="w-full py-4 px-8 rounded-2xl font-bold"
                    style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                           color: ${config.text_color || defaultConfig.text_color};
                           font-size: ${baseSize * 1.1}px;">
              ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
            </button>
          </div>
        </div>
      `;
      
      // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
      initPromise.then(allSaves => {
        const slotsContainer = document.getElementById('save-slots');
        
        if (allSaves.length === 0) {
          slotsContainer.innerHTML = `
            <div class="dialogue-box p-6 rounded-2xl text-center" 
                 style="font-size: ${baseSize}px; opacity: 0.7;">
              ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
          `;
        } else {
          slotsContainer.innerHTML = allSaves.map((save, index) => {
            const battleLog = JSON.parse(save.battle_log || '[]');
            const isCurrentSave = playerData && save.__backendId === playerData.__backendId;
            
            return `
              <div class="dialogue-box p-5 rounded-2xl slide-up ${isCurrentSave ? 'glow-effect' : ''}"
                   style="animation-delay: ${index * 0.1}s; ${isCurrentSave ? 'border: 2px solid ' + (config.primary_action_color || defaultConfig.primary_action_color) : ''}">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                      ${save.player_name}
                    </h3>
                    <p style="font-size: ${baseSize * 0.85}px; opacity: 0.7;">
                      Lv.${save.player_level} | æˆ¦é—˜å›æ•°: ${battleLog.length}
                    </p>
                  </div>
                  ${isCurrentSave ? `<span style="font-size: ${baseSize}px;">âœ…</span>` : ''}
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-3" style="font-size: ${baseSize * 0.8}px;">
                  <div>å…±æ„Ÿ: ${save.empathy}</div>
                  <div>æ´å¯Ÿ: ${save.insight}</div>
                  <div>å›å¾©: ${save.recovery}</div>
                  <div>å½±éŸ¿: ${save.influence}</div>
                </div>
                
                <div class="flex space-x-2">
                  ${!isCurrentSave ? `
                    <button class="load-save-btn flex-1 py-2 px-4 rounded-xl font-bold"
                            data-save-id="${save.__backendId}"
                            style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                                   color: ${config.text_color || defaultConfig.text_color};
                                   font-size: ${baseSize * 0.85}px;">
                      ãƒ­ãƒ¼ãƒ‰
                    </button>
                  ` : ''}
                  <button class="delete-save-btn flex-1 py-2 px-4 rounded-xl font-bold"
                          data-save-id="${save.__backendId}"
                          data-save-name="${save.player_name}"
                          style="background: #ef4444;
                                 color: ${config.text_color || defaultConfig.text_color};
                                 font-size: ${baseSize * 0.85}px;">
                    å‰Šé™¤
                  </button>
                </div>
              </div>
            `;
          }).join('');
          
          // ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          document.querySelectorAll('.load-save-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (isProcessing) return;
              
              isProcessing = true;
              btn.disabled = true;
              btn.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
              
              const saveId = btn.dataset.saveId;
              const targetSave = allSaves.find(s => s.__backendId === saveId);
              
              if (targetSave) {
                // ã“ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’playerDataã¨ã—ã¦ä½¿ç”¨
                playerData = targetSave;
                
                // ç”»é¢ã‚’æ›´æ–°
                setTimeout(() => {
                  isProcessing = false;
                  currentScene = 'story-intro';
                  renderCurrentScene();
                }, 500);
              } else {
                isProcessing = false;
                btn.disabled = false;
                btn.textContent = 'ãƒ­ãƒ¼ãƒ‰';
              }
            });
          });
          
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          document.querySelectorAll('.delete-save-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (isProcessing) return;
              
              const saveName = btn.dataset.saveName;
              const saveId = btn.dataset.saveId;
              
              // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç¢ºèªUI
              const parentDiv = btn.closest('.dialogue-box');
              const originalContent = parentDiv.innerHTML;
              
              parentDiv.innerHTML = `
                <div class="text-center space-y-4">
                  <p style="font-size: ${baseSize}px; font-weight: bold;">
                    ã€Œ${saveName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ
                  </p>
                  <p style="font-size: ${baseSize * 0.85}px; opacity: 0.8;">
                    ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“
                  </p>
                  <div class="flex space-x-3">
                    <button class="confirm-delete flex-1 py-3 px-4 rounded-xl font-bold"
                            style="background: #ef4444;
                                   color: ${config.text_color || defaultConfig.text_color};
                                   font-size: ${baseSize * 0.9}px;">
                      å‰Šé™¤ã™ã‚‹
                    </button>
                    <button class="cancel-delete flex-1 py-3 px-4 rounded-xl font-bold"
                            style="background: ${config.secondary_action_color || defaultConfig.secondary_action_color};
                                   color: ${config.text_color || defaultConfig.text_color};
                                   font-size: ${baseSize * 0.9}px;">
                      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                  </div>
                </div>
              `;
              
              parentDiv.querySelector('.cancel-delete').addEventListener('click', () => {
                parentDiv.innerHTML = originalContent;
                renderSaveLoad(app, config);
              });
              
              parentDiv.querySelector('.confirm-delete').addEventListener('click', async () => {
                if (isProcessing) return;
                
                isProcessing = true;
                parentDiv.querySelector('.confirm-delete').textContent = 'å‰Šé™¤ä¸­...';
                
                const targetSave = allSaves.find(s => s.__backendId === saveId);
                
                if (targetSave) {
                  const result = await window.dataSdk.delete(targetSave);
                  
                  if (result.isOk) {
                    // å‰Šé™¤ã—ãŸã®ãŒç¾åœ¨ã®ã‚»ãƒ¼ãƒ–ãªã‚‰ã€playerDataã‚’nullã«
                    if (playerData && playerData.__backendId === saveId) {
                      playerData = null;
                    }
                    
                    // ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
                    setTimeout(() => {
                      isProcessing = false;
                      renderCurrentScene();
                    }, 500);
                  } else {
                    parentDiv.innerHTML = `
                      <div class="text-center" style="color: #ef4444; font-size: ${baseSize}px;">
                        å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ
                      </div>
                    `;
                    setTimeout(() => {
                      isProcessing = false;
                      renderCurrentScene();
                    }, 2000);
                  }
                } else {
                  isProcessing = false;
                }
              });
            });
          });
        }
      });
      
      document.getElementById('back-to-title-btn').addEventListener('click', () => {
        currentScene = 'title';
        renderCurrentScene();
      });
    }

    function renderTitleScreen(app, config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      
      // ã‚¿ã‚¤ãƒˆãƒ«BGMé–‹å§‹
      playTitleBgm();
      
      app.innerHTML = `
        <div class="h-full w-full relative flex flex-col items-center justify-center fade-in" 
             style="background: linear-gradient(180deg, ${config.background_color || defaultConfig.background_color} 0%, #1a1a3e 100%);
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="absolute inset-0 opacity-20">
            <div class="absolute top-20 left-10 w-32 h-32 rounded-full pulse-effect" 
                 style="background: ${config.primary_action_color || defaultConfig.primary_action_color};"></div>
            <div class="absolute bottom-40 right-10 w-40 h-40 rounded-full pulse-effect" 
                 style="background: ${config.secondary_action_color || defaultConfig.secondary_action_color}; animation-delay: 1s;"></div>
          </div>
          
          <!-- éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
          <button id="bgm-toggle" 
                  class="absolute top-4 right-4 w-12 h-12 rounded-full flex items-center justify-center z-20"
                  style="background: ${config.surface_color || defaultConfig.surface_color}; 
                         font-size: ${baseSize * 1.5}px;
                         box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            ${bgmEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}
          </button>
          
          <div class="relative z-10 text-center px-8 w-full">
            <h1 class="mb-2 slide-up gradient-text" 
                style="font-size: ${baseSize * 2.5}px; font-weight: bold; letter-spacing: 2px;">
              ${config.main_title || defaultConfig.main_title}
            </h1>
            
            <p class="mb-6 slide-up" 
               style="font-size: ${baseSize * 1.2}px; opacity: 0.9; animation-delay: 0.2s;">
              ${config.subtitle || defaultConfig.subtitle}
            </p>
            
            <div class="my-10 slide-up" style="animation-delay: 0.4s;">
              <div class="text-7xl mb-4">ğŸ“</div>
              <p style="font-size: ${baseSize}px; opacity: 0.8; line-height: 1.6;">
                ${config.tagline || defaultConfig.tagline}
              </p>
            </div>
            
            <button id="start-btn" 
                    class="w-full max-w-md py-4 px-8 rounded-2xl font-bold glow-effect slide-up"
                    style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                           color: ${config.text_color || defaultConfig.text_color};
                           font-size: ${baseSize * 1.3}px;
                           animation-delay: 0.6s;">
              ${config.start_button || defaultConfig.start_button}
            </button>
            
            ${playerData ? `
              <div class="w-full max-w-md mt-4 space-y-3">
                <button id="continue-btn" 
                        class="w-full py-3 px-8 rounded-2xl font-bold slide-up"
                        style="background: ${config.secondary_action_color || defaultConfig.secondary_action_color};
                               color: ${config.text_color || defaultConfig.text_color};
                               font-size: ${baseSize}px;
                               opacity: 0.9;
                               animation-delay: 0.8s;">
                  ç¶šãã‹ã‚‰ (Lv.${playerData.player_level})
                </button>
                
                <button id="save-load-btn" 
                        class="w-full py-3 px-8 rounded-2xl font-bold slide-up"
                        style="background: transparent;
                               border: 2px solid ${config.primary_action_color || defaultConfig.primary_action_color};
                               color: ${config.text_color || defaultConfig.text_color};
                               font-size: ${baseSize * 0.9}px;
                               opacity: 0.9;
                               animation-delay: 1s;">
                  ğŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ç®¡ç†
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      document.getElementById('bgm-toggle').addEventListener('click', () => {
        bgmEnabled = !bgmEnabled;
        if (!bgmEnabled) {
          stopBgm();
        } else {
          playTitleBgm();
        }
        renderCurrentScene();
      });

      document.getElementById('start-btn').addEventListener('click', () => {
        currentScene = 'character-creation';
        renderCurrentScene();
      });

      if (playerData) {
        document.getElementById('continue-btn').addEventListener('click', () => {
          currentScene = 'story-intro';
          renderCurrentScene();
        });
        
        document.getElementById('save-load-btn')?.addEventListener('click', () => {
          currentScene = 'save-load';
          renderCurrentScene();
        });
      }
    }

    function renderCharacterCreation(app, config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-8 fade-in"
             style="background: ${config.background_color || defaultConfig.background_color};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="w-full max-w-md dialogue-box p-8 rounded-3xl slide-up">
            <h2 class="mb-6 text-center" 
                style="font-size: ${baseSize * 2}px; font-weight: bold;">
              ã‚ãªãŸã¯èª°ã§ã™ã‹ï¼Ÿ
            </h2>
            
            <form id="character-form" class="space-y-6">
              <div>
                <label for="player-name" class="block mb-3" 
                       style="font-size: ${baseSize * 1.1}px;">
                  åå‰
                </label>
                <input type="text" id="player-name" required
                       class="w-full p-4 rounded-xl border-2 text-center" 
                       style="background: ${config.surface_color || defaultConfig.surface_color}; 
                              border-color: ${config.primary_action_color || defaultConfig.primary_action_color};
                              color: ${config.text_color || defaultConfig.text_color};
                              font-size: ${baseSize * 1.2}px;"
                       placeholder="ã‚ãªãŸã®åå‰">
              </div>
              
              <div class="p-6 rounded-xl text-center" 
                   style="background: ${config.surface_color || defaultConfig.surface_color}; 
                          font-size: ${baseSize * 0.95}px;
                          line-height: 1.8;">
                <p class="mb-4" style="font-weight: bold; font-size: ${baseSize * 1.1}px;">åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</p>
                <div class="grid grid-cols-2 gap-3">
                  <div>å…±æ„Ÿ: 10</div>
                  <div>æ´å¯Ÿ: 10</div>
                  <div>å›å¾©: 10</div>
                  <div>å½±éŸ¿: 10</div>
                </div>
              </div>
              
              <button type="submit" id="create-btn" 
                      class="w-full py-4 px-8 rounded-2xl font-bold glow-effect" 
                      style="background: ${config.primary_action_color || defaultConfig.primary_action_color}; 
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 1.3}px;">
                æ—…ã‚’å§‹ã‚ã‚‹
              </button>
            </form>
          </div>
        </div>
      `;

      document.getElementById('character-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('create-btn');
        if (isProcessing) return;
        
        isProcessing = true;
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.textContent = 'ä½œæˆä¸­...';
        
        const name = document.getElementById('player-name').value;
        
        const result = await window.dataSdk.create({
          player_level: 1,
          player_name: name,
          empathy: 10,
          insight: 10,
          recovery: 10,
          influence: 10,
          anxiety_level: 50,
          hope_level: 50,
          confidence_level: 50,
          unlocked_skills: 'empathy,insight,reframe',
          completed_battles: '',
          battle_log: JSON.stringify([]),
          created_at: new Date().toISOString()
        });
        
        if (result.isOk) {
          setTimeout(() => {
            currentScene = 'story-intro';
            renderCurrentScene();
          }, 500);
        } else {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.textContent = 'æ—…ã‚’å§‹ã‚ã‚‹';
          
          const errorMsg = document.createElement('p');
          errorMsg.textContent = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorMsg.style.color = '#ef4444';
          errorMsg.style.marginTop = '1rem';
          errorMsg.style.textAlign = 'center';
          document.getElementById('character-form').appendChild(errorMsg);
        }
        
        isProcessing = false;
      });
    }

    function renderStoryIntro(app, config) {
      if (!playerData) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const battleLog = JSON.parse(playerData.battle_log || '[]');
      const victoryCount = battleLog.length;
      
      app.innerHTML = `
        <div id="story-intro-screen" class="h-full w-full flex flex-col items-center justify-center p-8 fade-in cursor-pointer"
             style="background: linear-gradient(180deg, ${config.background_color || defaultConfig.background_color} 0%, #1a1a3e 100%);
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="w-full max-w-md text-center space-y-6 slide-up pointer-events-none">
            <div>
              <h2 class="mb-3" style="font-size: ${baseSize * 2}px; font-weight: bold;">
                ç¬¬${victoryCount + 1}ç« 
              </h2>
              <p style="font-size: ${baseSize * 1.2}px; opacity: 0.9;">
                Lv.${playerData.player_level} ${playerData.player_name}
              </p>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl space-y-4" 
                 style="font-size: ${baseSize * 0.95}px; line-height: 1.8;">
              <p>ã‚ãªãŸã¯ä»Šã€äººç”Ÿã®å²è·¯ã«ç«‹ã£ã¦ã„ã‚‹ã€‚</p>
              <p>ç›®ã®å‰ã«ã¯ã€æ§˜ã€…ãªé¸æŠè‚¢ãŒåºƒãŒã£ã¦ã„ã‚‹ã€‚</p>
              <p>ã—ã‹ã—ã€å¿ƒã®ä¸­ã«ã¯ã€Œæ•µã€ãŒæ½œã‚“ã§ã„ã‚‹ã€‚</p>
              <p class="text-center pt-3" style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                ä¸å®‰ã€ç–‘å¿µã€ãã—ã¦éå»ã®å‚·...
              </p>
              <p>ã“ã‚Œã‚‰ã¨å‘ãåˆã„ã€ç†è§£ã—ã€ä¹—ã‚Šè¶Šãˆã‚‹ã“ã¨ã§ã€</p>
              <p>ã‚ãªãŸã¯æœ¬å½“ã®ç­”ãˆã‚’è¦‹ã¤ã‘ã‚‹ã ã‚ã†ã€‚</p>
            </div>
            
            <div class="space-y-4">
              <button id="auto-save-btn" 
                      class="w-full py-4 px-8 rounded-2xl font-bold glow-effect pointer-events-auto"
                      style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 1.3}px;">
                ğŸ’¾ è‡ªå‹•ã§ã‚»ãƒ¼ãƒ–
              </button>
              
              <button id="skill-tree-btn" 
                      class="w-full py-3 px-6 rounded-xl pointer-events-auto"
                      style="background: transparent;
                             border: 2px solid ${config.secondary_action_color || defaultConfig.secondary_action_color};
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 0.9}px;">
                ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è¦‹ã‚‹
              </button>
              
              <button id="view-log-btn" 
                      class="w-full py-3 px-6 rounded-xl pointer-events-auto"
                      style="background: transparent;
                             border: 2px solid ${config.primary_action_color || defaultConfig.primary_action_color};
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 0.9}px;">
                ğŸ“– æˆé•·ãƒ­ã‚°ã‚’è¦‹ã‚‹
              </button>
              
              ${victoryCount >= 7 ? `
                <button id="ending-btn" 
                        class="w-full py-4 px-8 rounded-2xl font-bold pointer-events-auto"
                        style="background: ${config.secondary_action_color || defaultConfig.secondary_action_color};
                               color: ${config.text_color || defaultConfig.text_color};
                               font-size: ${baseSize * 1.1}px;">
                  ç‰©èªã‚’çµ‚ãˆã‚‹
                </button>
              ` : ''}
            </div>
            
            <div class="pt-4" style="opacity: 0.7;">
              <p style="font-size: ${baseSize * 0.9}px;">
                ğŸ‘† ã‚¿ãƒƒãƒ—ã—ã¦æ¬¡ã®è©¦ç·´ã¸
              </p>
            </div>
          </div>
        </div>
      `;

      const setupRandomBattle = () => {
        const enemyIds = Object.keys(enemies);
        const randomEnemyId = enemyIds[Math.floor(Math.random() * enemyIds.length)];
        
        currentEnemy = { ...enemies[randomEnemyId] };
        battleState = {
          enemyHp: currentEnemy.maxHp,
          enemyMaxHp: currentEnemy.maxHp,
          anxiety: playerData.anxiety_level || 50,
          hope: playerData.hope_level || 50,
          turn: 0,
          messages: [],
          shield: 0,
          counter: false
        };
        currentScene = 'battle-intro';
        renderCurrentScene();
      };

      // ç”»é¢å…¨ä½“ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®è©¦ç·´ã¸
      document.getElementById('story-intro-screen')?.addEventListener('click', (e) => {
        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–ï¼ˆãƒœã‚¿ãƒ³ã¯å€‹åˆ¥ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒã¤ãŸã‚ï¼‰
        if (!e.target.closest('button')) {
          setupRandomBattle();
        }
      });

      // è‡ªå‹•ã‚»ãƒ¼ãƒ–ãƒœã‚¿ãƒ³
      document.getElementById('auto-save-btn')?.addEventListener('click', async (e) => {
        e.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’æ­¢ã‚ã‚‹
        
        if (isProcessing) return;
        
        const btn = document.getElementById('auto-save-btn');
        isProcessing = true;
        btn.disabled = true;
        btn.textContent = 'ğŸ’¾ ã‚»ãƒ¼ãƒ–ä¸­...';
        
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæ›´æ–°ï¼‰
        const result = await window.dataSdk.update({
          ...playerData
        });
        
        if (result.isOk) {
          btn.textContent = 'âœ… ã‚»ãƒ¼ãƒ–å®Œäº†ï¼';
          setTimeout(() => {
            btn.textContent = 'ğŸ’¾ è‡ªå‹•ã§ã‚»ãƒ¼ãƒ–';
            btn.disabled = false;
            isProcessing = false;
          }, 1500);
        } else {
          btn.textContent = 'âŒ ã‚»ãƒ¼ãƒ–å¤±æ•—';
          setTimeout(() => {
            btn.textContent = 'ğŸ’¾ è‡ªå‹•ã§ã‚»ãƒ¼ãƒ–';
            btn.disabled = false;
            isProcessing = false;
          }, 1500);
        }
      });

      document.getElementById('skill-tree-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        currentScene = 'skill-tree';
        renderCurrentScene();
      });
      document.getElementById('view-log-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        currentScene = 'emotion-log';
        renderCurrentScene();
      });
      document.getElementById('ending-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        currentScene = 'ending';
        renderCurrentScene();
      });
    }

    function renderSkillTree(app, config) {
      if (!playerData) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const allSkills = Object.values(skillDatabase).sort((a, b) => a.level - b.level);
      const unlockedSkillIds = getUnlockedSkills().map(s => s.id);
      
      const tierColors = {
        1: '#10b981'
      };
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto p-6 fade-in"
             style="background: ${config.background_color || defaultConfig.background_color};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="max-w-md mx-auto space-y-6">
            <div class="text-center mb-6">
              <h2 class="mb-2" style="font-size: ${baseSize * 2}px; font-weight: bold;">
                ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼
              </h2>
              <p style="font-size: ${baseSize}px; opacity: 0.8;">
                Lv.${playerData.player_level} - ${unlockedSkillIds.length}å€‹ç¿’å¾—
              </p>
            </div>
            
            <div class="dialogue-box p-5 rounded-3xl slide-up">
              <div class="flex items-center justify-between mb-4">
                <h3 style="font-size: ${baseSize * 1.2}px; font-weight: bold; color: ${tierColors[1]};">
                  Tier 1
                </h3>
                <span style="font-size: ${baseSize * 0.85}px; opacity: 0.7;">
                  åˆç´šãƒ»åˆ†ææ”»æ’ƒæœŸ
                </span>
              </div>
              
              <div class="space-y-3">
                ${allSkills.map(skill => {
                  const isUnlocked = unlockedSkillIds.includes(skill.id);
                  const isAvailable = skill.level <= playerData.player_level;
                  
                  return `
                    <div class="skill-card ${!isUnlocked ? 'locked' : ''} skill-tier-${skill.tier} p-4 rounded-xl"
                         style="background: ${config.surface_color || defaultConfig.surface_color};">
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center space-x-2">
                          <span style="font-size: ${baseSize * 1.5}px;">${skill.icon}</span>
                          <div>
                            <h4 style="font-size: ${baseSize}px; font-weight: bold;">
                              ${skill.name}
                            </h4>
                            <p style="font-size: ${baseSize * 0.75}px; opacity: 0.6;">
                              Lv.${skill.level} | ${skill.type === 'empathy' ? 'å…±æ„Ÿ' : skill.type === 'insight' ? 'æ´å¯Ÿ' : 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒ '}
                            </p>
                          </div>
                        </div>
                        ${isUnlocked ? `<span class="sparkle-effect" style="font-size: ${baseSize * 1.2}px;">âœ¨</span>` : 
                          !isAvailable ? `<span style="font-size: ${baseSize}px; opacity: 0.5;">ğŸ”’</span>` : ''}
                      </div>
                      
                      <p style="font-size: ${baseSize * 0.85}px; opacity: 0.8; line-height: 1.5; margin-bottom: 0.5rem;">
                        ${skill.description}
                      </p>
                      
                      <div class="flex items-center justify-between" style="font-size: ${baseSize * 0.8}px;">
                        <span style="color: ${tierColors[skill.tier]};">âš”ï¸ ${skill.damage}ãƒ€ãƒ¡ãƒ¼ã‚¸</span>
                        <span style="opacity: 0.7;">${skill.effect}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <button id="back-btn" 
                    class="w-full py-4 px-8 rounded-2xl font-bold"
                    style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                           color: ${config.text_color || defaultConfig.text_color};
                           font-size: ${baseSize * 1.1}px;">
              æˆ»ã‚‹
            </button>
          </div>
        </div>
      `;

      document.getElementById('back-btn').addEventListener('click', () => {
        currentScene = 'story-intro';
        renderCurrentScene();
      });
    }

    function renderBattleIntro(app, config) {
      if (!currentEnemy) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      
      // ãƒãƒˆãƒ«BGMé–‹å§‹
      playBattleBgm();
      
      // æ•µã®SVGã‚’ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼šçµµæ–‡å­—ã§ä»£ç”¨ï¼‰
      const enemyVisual = currentEnemy.id;
      
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center fade-in"
             style="background: ${currentEnemy.background};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="w-full text-center space-y-10 px-8">
            <div class="pulse-effect" style="font-size: 140px;">
              ${enemyVisual === 'anxiety' ? 'ğŸŒ‘' : 
                enemyVisual === 'overwork' ? 'âš™ï¸' : 
                enemyVisual === 'selfDoubt' ? 'â›“ï¸' : 
                enemyVisual === 'burnout' ? 'ğŸ”¥' : 
                enemyVisual === 'conformity' ? 'ğŸ‘¥' : 
                enemyVisual === 'judgment' ? 'âš–ï¸' : 
                enemyVisual === 'maze' ? 'ğŸŒ€' : 
                enemyVisual === 'ideal' ? 'ğŸ’«' : 
                enemyVisual === 'role' ? 'ğŸ­' : 'ğŸ•³ï¸'}
            </div>
            
            <h2 class="slide-up" 
                style="font-size: ${baseSize * 2.2}px; font-weight: bold; letter-spacing: 2px;">
              ${currentEnemy.name}
            </h2>
            
            <p class="slide-up dialogue-box p-6 rounded-2xl mx-auto max-w-md" 
               style="font-size: ${baseSize * 1.1}px; animation-delay: 0.3s;">
              ${currentEnemy.catchphrase}
            </p>
            
            <div class="slide-up" style="animation-delay: 0.6s;">
              <div class="text-5xl space-x-6">
                <span style="animation: pulse 1s infinite;">âš¡</span>
                <span style="animation: pulse 1s infinite; animation-delay: 0.3s;">âš¡</span>
                <span style="animation: pulse 1s infinite; animation-delay: 0.6s;">âš¡</span>
              </div>
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        currentScene = 'battle';
        renderCurrentScene();
      }, 3000);
    }

    function renderBattleScreen(app, config) {
      if (!currentEnemy || !playerData) {
        console.error('Battle screen render failed: missing data');
        return;
      }
      
      console.log('Rendering battle screen, isProcessing:', isProcessing);
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const hpPercent = (battleState.enemyHp / battleState.enemyMaxHp) * 100;
      
      const currentDialogue = battleState.enemyHp < battleState.enemyMaxHp * 0.3 
        ? currentEnemy.dialogue.weak 
        : battleState.turn === 0 
          ? currentEnemy.dialogue.intro 
          : currentEnemy.dialogue.attack;
      
      const availableSkills = getAvailableSkillsForBattle();
      
      const tierColors = {
        1: '#10b981'
      };
      
      // æ•µã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
      const enemyVisual = currentEnemy.id === 'anxiety' ? 'ğŸŒ‘' : 
                         currentEnemy.id === 'overwork' ? 'âš™ï¸' : 
                         currentEnemy.id === 'selfDoubt' ? 'â›“ï¸' : 
                         currentEnemy.id === 'burnout' ? 'ğŸ”¥' : 
                         currentEnemy.id === 'conformity' ? 'ğŸ‘¥' : 
                         currentEnemy.id === 'judgment' ? 'âš–ï¸' : 
                         currentEnemy.id === 'maze' ? 'ğŸŒ€' : 
                         currentEnemy.id === 'ideal' ? 'ğŸ’«' : 
                         currentEnemy.id === 'role' ? 'ğŸ­' : 'ğŸ•³ï¸';
      
      app.innerHTML = `
        <div class="h-full w-full flex flex-col fade-in"
             style="background: ${currentEnemy.background};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <!-- ä¸Šéƒ¨ã‚¨ãƒªã‚¢: æ•µæƒ…å ±ï¼ˆ20%ï¼‰ -->
          <div class="px-4 pt-4 pb-2" style="height: 20%;">
            <div class="dialogue-box p-4 rounded-2xl h-full flex flex-col justify-center">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div id="enemy-sprite" class="transition-all duration-300" style="font-size: 50px;">
                    ${enemyVisual}
                  </div>
                  <div>
                    <h3 style="font-size: ${baseSize}px; font-weight: bold; margin-bottom: 0.25rem;">
                      ${currentEnemy.name}
                    </h3>
                    <div class="flex items-center space-x-2">
                      <span style="font-size: ${baseSize * 0.7}px; opacity: 0.7;">HP</span>
                      <div class="flex-1" style="width: 120px;">
                        <div class="h-1.5 rounded-full overflow-hidden" 
                             style="background: rgba(255, 255, 255, 0.2);">
                          <div id="hp-bar" class="h-full transition-all duration-500" 
                               style="width: ${hpPercent}%; background: linear-gradient(90deg, #ef4444, #f59e0b);"></div>
                        </div>
                      </div>
                      <span style="font-size: ${baseSize * 0.7}px; opacity: 0.8;">${battleState.enemyHp}</span>
                    </div>
                  </div>
                </div>
                ${battleState.shield > 0 ? `<div style="font-size: ${baseSize * 1.5}px;">ğŸ›¡ï¸</div>` : ''}
              </div>
            </div>
          </div>
          
          <!-- ä¸­å¤®ã‚¨ãƒªã‚¢: ã‚»ãƒªãƒ•ï¼‹ä¸»äººå…¬ï¼ˆ35%ï¼‰ -->
          <div class="px-4 py-2 flex-1" style="height: 35%;">
            <div class="h-full flex flex-col justify-between space-y-2">
              <!-- ã‚»ãƒªãƒ• -->
              <div id="dialogue-window" class="dialogue-box p-4 rounded-2xl flex items-center justify-center">
                <p style="font-size: ${baseSize * 0.85}px; line-height: 1.5; font-style: italic; text-align: center;">
                  ${currentDialogue}
                </p>
              </div>
              
              <!-- ä¸»äººå…¬ -->
              <div class="dialogue-box p-3 rounded-2xl">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <div id="player-sprite" class="transition-all duration-300">
                      <svg width="60" height="60" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" style="image-rendering: pixelated;">
                        <rect x="18" y="8" width="12" height="10" fill="#ffdbac"/>
                        <rect x="17" y="6" width="14" height="3" fill="#8b5a3c"/>
                        <rect x="16" y="7" width="2" height="5" fill="#8b5a3c"/>
                        <rect x="30" y="7" width="2" height="5" fill="#8b5a3c"/>
                        <rect x="18" y="6" width="12" height="2" fill="#6b4423"/>
                        <rect x="20" y="12" width="2" height="2" fill="#2d2d2d"/>
                        <rect x="26" y="12" width="2" height="2" fill="#2d2d2d"/>
                        <rect x="20" y="13" width="1" height="1" fill="#ffffff"/>
                        <rect x="26" y="13" width="1" height="1" fill="#ffffff"/>
                        <rect x="20" y="11" width="2" height="1" fill="#6b4423"/>
                        <rect x="26" y="11" width="2" height="1" fill="#6b4423"/>
                        <rect x="22" y="15" width="4" height="1" fill="#2d2d2d"/>
                        <rect x="21" y="16" width="1" height="1" fill="#2d2d2d"/>
                        <rect x="26" y="16" width="1" height="1" fill="#2d2d2d"/>
                        <rect x="21" y="18" width="6" height="2" fill="#ffdbac"/>
                        <rect x="15" y="20" width="18" height="14" fill="#1a2332"/>
                        <rect x="21" y="20" width="6" height="12" fill="#ffffff"/>
                        <rect x="23" y="20" width="2" height="8" fill="#2d5a8f"/>
                        <rect x="22" y="28" width="1" height="1" fill="#2d5a8f"/>
                        <rect x="25" y="28" width="1" height="1" fill="#2d5a8f"/>
                        <rect x="20" y="20" width="1" height="3" fill="#1a2332"/>
                        <rect x="27" y="20" width="1" height="3" fill="#1a2332"/>
                        <rect x="19" y="21" width="1" height="2" fill="#1a2332"/>
                        <rect x="28" y="21" width="1" height="2" fill="#1a2332"/>
                        <rect x="12" y="22" width="3" height="2" fill="#ffdbac"/>
                        <rect x="10" y="24" width="4" height="8" fill="#1a2332"/>
                        <rect x="33" y="22" width="3" height="2" fill="#ffdbac"/>
                        <rect x="34" y="24" width="4" height="8" fill="#1a2332"/>
                        <rect x="36" y="28" width="6" height="8" fill="#5c4033"/>
                        <rect x="37" y="29" width="4" height="6" fill="#6b4423"/>
                        <rect x="39" y="26" width="1" height="2" fill="#3d2817"/>
                        <rect x="39" y="31" width="1" height="1" fill="#ffd700"/>
                        <rect x="23" y="28" width="1" height="1" fill="#cccccc"/>
                        <rect x="24" y="28" width="1" height="1" fill="#cccccc"/>
                        <rect x="23" y="31" width="1" height="1" fill="#cccccc"/>
                        <rect x="24" y="31" width="1" height="1" fill="#cccccc"/>
                      </svg>
                    </div>
                    <div>
                      <div style="font-size: ${baseSize * 0.8}px; font-weight: bold; margin-bottom: 0.25rem;">
                        ${playerData.player_name}
                      </div>
                      <div class="flex items-center space-x-2" style="font-size: ${baseSize * 0.65}px;">
                        <span>ğŸ˜°${battleState.anxiety}%</span>
                        <span>âœ¨${battleState.hope}%</span>
                      </div>
                    </div>
                  </div>
                  <button id="auto-attack-btn" 
                          class="px-4 py-2 rounded-full font-bold"
                          style="background: ${config.secondary_action_color || defaultConfig.secondary_action_color};
                                 color: ${config.text_color || defaultConfig.text_color};
                                 font-size: ${baseSize * 0.75}px;">
                    âš¡è‡ªå‹•
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ä¸‹éƒ¨ã‚¨ãƒªã‚¢: ã‚¹ã‚­ãƒ«ãƒãƒ¼ï¼ˆ45%ï¼‰ -->
          <div class="px-4 pb-4" style="height: 45%;">
            <div class="h-full flex flex-col">
              <div class="mb-2 px-2">
                <p style="font-size: ${baseSize * 0.75}px; opacity: 0.7; text-align: center;">
                  ã‚¹ã‚­ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç™ºå‹• ğŸ‘†
                </p>
              </div>
              
              <div id="skill-scroll-container" class="flex-1 overflow-x-auto overflow-y-hidden">
                <div class="flex space-x-3 h-full px-2" style="min-width: min-content;">
                  ${availableSkills.map((skill, index) => {
                    const tierColor = tierColors[skill.tier] || config.primary_action_color;
                    return `
                      <button class="skill-card-btn dialogue-box flex-shrink-0 p-4 rounded-2xl transition-all duration-200"
                              data-skill-index="${index}"
                              style="width: 160px; 
                                     border-left: 4px solid ${tierColor};
                                     background: ${config.surface_color || defaultConfig.surface_color};">
                        <div class="h-full flex flex-col justify-between">
                          <div class="text-center mb-2">
                            <div style="font-size: ${baseSize * 2.5}px; margin-bottom: 0.5rem;">
                              ${skill.icon}
                            </div>
                            <h4 style="font-size: ${baseSize * 0.85}px; font-weight: bold; margin-bottom: 0.25rem; color: ${tierColor};">
                              ${skill.name}
                            </h4>
                            <p style="font-size: ${baseSize * 0.65}px; opacity: 0.7; line-height: 1.3;">
                              ${skill.description}
                            </p>
                          </div>
                          <div class="text-center space-y-1">
                            <div style="font-size: ${baseSize * 0.9}px; font-weight: bold; color: ${tierColor};">
                              âš”ï¸ ${skill.damage}
                            </div>
                            <div style="font-size: ${baseSize * 0.6}px; opacity: 0.6;">
                              ${skill.effect}
                            </div>
                          </div>
                        </div>
                      </button>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      availableSkills.forEach((skill, index) => {
        const btn = document.querySelector(`[data-skill-index="${index}"]`);
        if (btn && !btn.dataset.listenerAttached) {
          btn.dataset.listenerAttached = 'true';
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Skill button clicked:', skill.name);
            await executeSkill(skill);
          });
        }
      });

      // è‡ªå‹•æ”»æ’ƒãƒœã‚¿ãƒ³
      const autoBtn = document.getElementById('auto-attack-btn');
      if (autoBtn && !autoBtn.dataset.listenerAttached) {
        autoBtn.dataset.listenerAttached = 'true';
        autoBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Auto attack button clicked');
          
          if (availableSkills.length > 0) {
            const randomSkill = availableSkills[Math.floor(Math.random() * availableSkills.length)];
            await executeSkill(randomSkill);
          }
        });
      }
    }

    async function saveBattleResultAndShowResult() {
      console.log('Saving battle result...');
      
      try {
        playDefeatSound();
      } catch (e) {
        console.warn('Failed to play defeat sound:', e);
      }
      
      const newLevel = Math.min(100, playerData.player_level + 1);
      const statIncrease = 3;
      
      const battleLog = JSON.parse(playerData.battle_log || '[]');
      battleLog.push({
        enemy: currentEnemy.name,
        level: newLevel,
        date: new Date().toISOString(),
        anxiety: battleState.anxiety,
        hope: battleState.hope
      });
      
      try {
        const result = await window.dataSdk.update({
          ...playerData,
          player_level: newLevel,
          empathy: playerData.empathy + statIncrease,
          insight: playerData.insight + statIncrease,
          recovery: playerData.recovery + statIncrease,
          influence: playerData.influence + statIncrease,
          anxiety_level: battleState.anxiety,
          hope_level: battleState.hope,
          confidence_level: Math.min(100, playerData.confidence_level + 10),
          battle_log: JSON.stringify(battleLog)
        });
        
        if (result.isOk) {
          console.log('Battle result saved successfully');
        } else {
          console.warn('Failed to save battle result, but continuing...');
        }
      } catch (error) {
        console.error('Error saving battle result:', error);
      }
      
      // çµæœç”»é¢ã¸é·ç§»ï¼ˆã‚»ãƒ¼ãƒ–æˆå¦ã«é–¢ã‚ã‚‰ãšï¼‰
      await new Promise(resolve => setTimeout(resolve, 1500));
      currentScene = 'result';
      isProcessing = false;
      renderCurrentScene();
    }

    async function executeSkill(skill) {
      if (isProcessing) {
        console.log('Already processing, skipping...');
        return;
      }
      
      console.log('Starting skill execution:', skill.name);
      isProcessing = true;
      
      try {
        // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
        try {
          if (skill.soundType === 'attack') {
            playAttackSound();
          } else if (skill.soundType === 'magic') {
            playMagicSound();
          } else if (skill.soundType === 'defense') {
            playDefenseSound();
          }
        } catch (audioError) {
          console.warn('Audio playback failed:', audioError);
        }
        
        const enemySprite = document.getElementById('enemy-sprite');
        const playerSprite = document.getElementById('player-sprite');
        const buttons = document.querySelectorAll('.skill-card-btn, #auto-attack-btn');
        const dialogue = document.getElementById('dialogue-window');
        
        // ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.style.pointerEvents = 'none';
        });
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ”»æ’ƒã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (playerSprite) {
          playerSprite.classList.add('attack-effect');
        }
        
        // æ•µãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (enemySprite) {
          setTimeout(() => {
            enemySprite.classList.add('damage-effect');
          }, 200);
        }
        
        let damage = skill.damage;
        let anxietyChange = 0;
        let hopeChange = 0;
        
        const isWeakness = skill.type === currentEnemy.weakness;
        
        if (isWeakness) {
          damage = Math.floor(damage * 1.5);
          anxietyChange = -15;
          hopeChange = 15;
        } else {
          anxietyChange = -5;
          hopeChange = 5;
        }
        
        // ã‚¹ã‚­ãƒ«å›ºæœ‰åŠ¹æœ
        if (skill.effect && skill.effect.includes('å›å¾©')) {
          hopeChange += 20;
        }
        if (skill.effect && (skill.effect.includes('ãƒãƒªã‚¢') || skill.effect.includes('ã‚·ãƒ¼ãƒ«ãƒ‰'))) {
          battleState.shield = 30;
        }
        if (skill.effect && skill.effect.includes('ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼')) {
          battleState.counter = true;
        }
        
        // ã‚¹ã‚­ãƒ«åŠ¹æœè¡¨ç¤º
        if (dialogue) {
          const config = getConfig();
          const baseSize = config.font_size || defaultConfig.font_size;
          const tierColors = {
            1: '#10b981'
          };
          
          dialogue.innerHTML = `
            <div class="text-center space-y-2">
              <div style="font-size: ${baseSize * 2}px;">${skill.icon}</div>
              <p style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                ${skill.name}
              </p>
              <p style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${tierColors[skill.tier]};">
                ${damage} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼
              </p>
              ${isWeakness ? `<p style="font-size: ${baseSize}px; color: #f59e0b;">âœ¨ å¼±ç‚¹ã‚’ã¤ã„ãŸï¼</p>` : ''}
            </div>
          `;
          dialogue.classList.add('pulse-effect');
        }
        
        // ã‚¹ãƒ†ãƒ¼ãƒˆæ›´æ–°
        battleState.enemyHp = Math.max(0, battleState.enemyHp - damage);
        battleState.anxiety = Math.max(0, Math.min(100, battleState.anxiety + anxietyChange));
        battleState.hope = Math.max(0, Math.min(100, battleState.hope + hopeChange));
        battleState.turn++;
        
        console.log('Battle state updated:', {
          enemyHp: battleState.enemyHp,
          anxiety: battleState.anxiety,
          hope: battleState.hope
        });
        
        // HPãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const hpBar = document.getElementById('hp-bar');
        if (hpBar) {
          const hpPercent = (battleState.enemyHp / battleState.enemyMaxHp) * 100;
          hpBar.style.width = `${hpPercent}%`;
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å¾…ã¤
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        if (playerSprite) {
          playerSprite.classList.remove('attack-effect');
        }
        if (enemySprite) {
          enemySprite.classList.remove('damage-effect');
        }
        if (dialogue) {
          dialogue.classList.remove('pulse-effect');
        }
        
        // å‹åˆ©åˆ¤å®š
        if (battleState.enemyHp <= 0) {
          console.log('Enemy defeated, saving result...');
          await saveBattleResultAndShowResult();
          return; // å‡¦ç†å®Œäº†å¾Œã¯å³åº§ã«return
        }
        
        // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
        console.log('Continuing to next turn...');
        isProcessing = false;
        renderCurrentScene();
        
      } catch (error) {
        console.error('Critical error in executeSkill:', error);
        isProcessing = false;
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç”»é¢ã‚’å†æç”»ã—ã¦å¾©æ—§ã‚’è©¦ã¿ã‚‹
        try {
          renderCurrentScene();
        } catch (renderError) {
          console.error('Failed to recover from error:', renderError);
          // æœ€æ‚ªã®å ´åˆã¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”»é¢ã«æˆ»ã‚‹
          currentScene = 'story-intro';
          renderCurrentScene();
        }
      }
    }

    function renderResultScreen(app, config) {
      if (!playerData) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      
      // å‹åˆ©BGMå†ç”Ÿ
      playVictoryBgm();
      
      app.innerHTML = `
        <div id="result-screen" class="h-full w-full flex flex-col items-center justify-center p-8 fade-in cursor-pointer"
             style="background: linear-gradient(180deg, ${config.primary_action_color || defaultConfig.primary_action_color}30 0%, ${config.background_color || defaultConfig.background_color} 100%);
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="w-full max-w-md text-center space-y-6 pointer-events-none">
            <div class="slide-up">
              <div class="text-6xl mb-4">âœ¨</div>
              <h2 style="font-size: ${baseSize * 2}px; font-weight: bold;">
                ç†è§£ã‚’å¾—ãŸ
              </h2>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl slide-up" style="animation-delay: 0.3s;">
              <p class="mb-4" style="font-size: ${baseSize * 1.5}px; font-weight: bold;">
                Lv.${playerData.player_level - 1} â†’ Lv.${playerData.player_level}
              </p>
              <div class="text-5xl">â¬†ï¸</div>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl slide-up space-y-4" style="animation-delay: 0.6s;">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: bold;">æˆé•·ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
              <div class="grid grid-cols-2 gap-4" style="font-size: ${baseSize}px;">
                <div class="space-y-1">
                  <p>å…±æ„Ÿ: ${playerData.empathy - 3} â†’ ${playerData.empathy} ğŸ“ˆ</p>
                  <p>æ´å¯Ÿ: ${playerData.insight - 3} â†’ ${playerData.insight} ğŸ“ˆ</p>
                </div>
                <div class="space-y-1">
                  <p>å›å¾©: ${playerData.recovery - 3} â†’ ${playerData.recovery} ğŸ“ˆ</p>
                  <p>å½±éŸ¿: ${playerData.influence - 3} â†’ ${playerData.influence} ğŸ“ˆ</p>
                </div>
              </div>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl slide-up" 
                 style="animation-delay: 0.9s;
                        font-size: ${baseSize * 0.95}px;
                        line-height: 1.8;">
              <p style="font-weight: bold; margin-bottom: 0.5rem;">å¯¾è©±ãŒåŠ›ã«å¤‰ã‚ã‚‹</p>
              <p>ã€Œ${currentEnemy.name}ã€ã‚’ç†è§£ã—ãŸã‚ãªãŸã¯ã€</p>
              <p>æ–°ãŸãªã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã€ã•ã‚‰ã«å¼·ããªã£ãŸã€‚</p>
            </div>
            
            <div class="slide-up pt-4" style="animation-delay: 1.2s;">
              <p style="font-size: ${baseSize * 0.9}px; opacity: 0.7;">
                ğŸ‘† ã‚¿ãƒƒãƒ—ã—ã¦ç¶šã‘ã‚‹
              </p>
            </div>
          </div>
        </div>
      `;

      document.getElementById('result-screen').addEventListener('click', () => {
        currentEnemy = null;
        currentScene = 'story-intro';
        renderCurrentScene();
      });
    }

    function renderEmotionLog(app, config) {
      if (!playerData) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const battleLog = JSON.parse(playerData.battle_log || '[]');
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto p-8 fade-in"
             style="background: ${config.background_color || defaultConfig.background_color};
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="max-w-md mx-auto space-y-6">
            <div class="text-center mb-6">
              <h2 class="mb-2" style="font-size: ${baseSize * 2}px; font-weight: bold;">
                ğŸ“– æˆé•·ã®è¨˜éŒ²
              </h2>
              <p style="font-size: ${baseSize}px; opacity: 0.8;">
                ${playerData.player_name}ã®æ—…è·¯
              </p>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl slide-up">
              <h3 class="mb-4" style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                ç¾åœ¨ã®çŠ¶æ…‹ (Lv.${playerData.player_level})
              </h3>
              <div class="space-y-3" style="font-size: ${baseSize * 0.9}px;">
                <div>
                  <div class="flex justify-between mb-1">
                    <span>ğŸ˜° ä¸å®‰</span>
                    <span>${playerData.anxiety_level}%</span>
                  </div>
                  <div class="w-full h-2 rounded-full overflow-hidden" 
                       style="background: ${config.surface_color || defaultConfig.surface_color};">
                    <div class="h-full" style="width: ${playerData.anxiety_level}%; background: #ef4444;"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span>âœ¨ å¸Œæœ›</span>
                    <span>${playerData.hope_level}%</span>
                  </div>
                  <div class="w-full h-2 rounded-full overflow-hidden" 
                       style="background: ${config.surface_color || defaultConfig.surface_color};">
                    <div class="h-full" style="width: ${playerData.hope_level}%; background: #10b981;"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span>ğŸ’ª è‡ªä¿¡</span>
                    <span>${playerData.confidence_level}%</span>
                  </div>
                  <div class="w-full h-2 rounded-full overflow-hidden" 
                       style="background: ${config.surface_color || defaultConfig.surface_color};">
                    <div class="h-full" style="width: ${playerData.confidence_level}%; background: ${config.primary_action_color || defaultConfig.primary_action_color};"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="space-y-4">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                æˆ¦ã„ã®è¨˜éŒ²
              </h3>
              ${battleLog.length === 0 ? `
                <div class="dialogue-box p-6 rounded-2xl text-center" 
                     style="font-size: ${baseSize * 0.9}px; opacity: 0.7;">
                  ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                </div>
              ` : battleLog.slice().reverse().map((log, index) => `
                <div class="dialogue-box p-4 rounded-2xl slide-up" 
                     style="animation-delay: ${index * 0.1}s;">
                  <div class="flex justify-between items-center mb-2">
                    <h4 style="font-size: ${baseSize * 1.1}px; font-weight: bold;">
                      ${log.enemy}
                    </h4>
                    <span style="font-size: ${baseSize * 0.85}px; opacity: 0.7;">
                      Lv.${log.level}
                    </span>
                  </div>
                  <div class="grid grid-cols-2 gap-3" style="font-size: ${baseSize * 0.85}px;">
                    <p>ä¸å®‰: ${log.anxiety}%</p>
                    <p>å¸Œæœ›: ${log.hope}%</p>
                  </div>
                  <p class="mt-2" style="font-size: ${baseSize * 0.75}px; opacity: 0.6;">
                    ${new Date(log.date).toLocaleDateString('ja-JP')}
                  </p>
                </div>
              `).join('')}
            </div>
            
            <button id="back-btn" 
                    class="w-full py-4 px-8 rounded-2xl font-bold"
                    style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                           color: ${config.text_color || defaultConfig.text_color};
                           font-size: ${baseSize * 1.1}px;">
              æˆ»ã‚‹
            </button>
          </div>
        </div>
      `;

      document.getElementById('back-btn').addEventListener('click', () => {
        currentScene = 'story-intro';
        renderCurrentScene();
      });
    }

    function renderEnding(app, config) {
      if (!playerData) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      
      let endingType = 'growth';
      let endingTitle = 'æˆé•·ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°';
      let endingMessage = 'ã‚ãªãŸã¯å¤šãã®è‘›è—¤ã¨å‘ãåˆã„ã€ãã‚Œã‚‰ã‚’ç†è§£ã—ãŸã€‚';
      
      if (playerData.anxiety_level < 30 && playerData.hope_level > 70) {
        endingType = 'hope';
        endingTitle = 'å¸Œæœ›ã®å¤œæ˜ã‘';
        endingMessage = 'ã‹ã¤ã¦ã®ä¸å®‰ã¯ã€ä»Šã‚„è¡Œå‹•ã¸ã®åŸå‹•åŠ›ã¨ãªã£ãŸã€‚';
      } else if (playerData.confidence_level > 80) {
        endingType = 'confidence';
        endingTitle = 'è‡ªä¿¡ã®ç²å¾—';
        endingMessage = 'ã‚ãªãŸã¯è‡ªåˆ†ã®ä¾¡å€¤ã‚’ã€è‡ªåˆ†ã§æ±ºã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚';
      }
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto fade-in"
             style="background: linear-gradient(180deg, #1a1a3e 0%, ${config.primary_action_color || defaultConfig.primary_action_color}20 50%, ${config.background_color || defaultConfig.background_color} 100%);
                    color: ${config.text_color || defaultConfig.text_color};
                    font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;">
          
          <div class="min-h-full w-full flex flex-col items-center justify-center p-8 py-12">
          <div class="w-full max-w-md text-center space-y-8">
            <div class="text-7xl slide-up">
              ${endingType === 'hope' ? 'ğŸŒ…' : endingType === 'confidence' ? 'â­' : 'ğŸŒŸ'}
            </div>
            
            <div class="slide-up" style="animation-delay: 0.3s;">
              <h2 class="gradient-text mb-3" 
                  style="font-size: ${baseSize * 2.2}px; font-weight: bold;">
                ${endingTitle}
              </h2>
              <p style="font-size: ${baseSize * 1.1}px; opacity: 0.9;">
                Lv.${playerData.player_level} ${playerData.player_name}
              </p>
            </div>
            
            <div class="dialogue-box p-8 rounded-3xl slide-up space-y-4" 
                 style="animation-delay: 0.6s;
                        font-size: ${baseSize * 0.95}px;
                        line-height: 2;">
              <p>${endingMessage}</p>
              <p>ã‚­ãƒ£ãƒªã‚¢ã®æ—…è·¯ã«ã€çµ‚ã‚ã‚Šã¯ãªã„ã€‚</p>
              <p>ã—ã‹ã—ä»Šã€ã‚ãªãŸã¯ç¢ºã‹ã«</p>
              <p class="text-center pt-2" style="font-size: ${baseSize * 1.3}px; font-weight: bold;">
                å‰ã«é€²ã‚€åŠ›ã‚’æŒã£ã¦ã„ã‚‹
              </p>
            </div>
            
            <div class="dialogue-box p-6 rounded-3xl slide-up" 
                 style="animation-delay: 0.9s;">
              <h3 class="mb-4" style="font-size: ${baseSize * 1.2}px; font-weight: bold;">
                æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
              </h3>
              <div class="grid grid-cols-2 gap-4" style="font-size: ${baseSize}px;">
                <div>å…±æ„Ÿ: ${playerData.empathy}</div>
                <div>æ´å¯Ÿ: ${playerData.insight}</div>
                <div>å›å¾©: ${playerData.recovery}</div>
                <div>å½±éŸ¿: ${playerData.influence}</div>
              </div>
            </div>
            
            <div class="space-y-4 slide-up" style="animation-delay: 1.2s;">
              <button id="log-btn" 
                      class="w-full py-4 px-8 rounded-2xl font-bold"
                      style="background: ${config.primary_action_color || defaultConfig.primary_action_color};
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 1.1}px;">
                ğŸ“– æ—…è·¯ã‚’æŒ¯ã‚Šè¿”ã‚‹
              </button>
              
              <button id="title-btn" 
                      class="w-full py-3 px-8 rounded-2xl font-bold"
                      style="background: transparent;
                             border: 2px solid ${config.secondary_action_color || defaultConfig.secondary_action_color};
                             color: ${config.text_color || defaultConfig.text_color};
                             font-size: ${baseSize * 0.95}px;">
                ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
              </button>
            </div>
          </div>
          </div>
        </div>
      `;

      document.getElementById('log-btn').addEventListener('click', () => {
        currentScene = 'emotion-log';
        renderCurrentScene();
      });

      document.getElementById('title-btn').addEventListener('click', () => {
        currentScene = 'title';
        renderCurrentScene();
      });
    }

    initializeSDKs().then(() => {
      renderCurrentScene();
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b89dcb7f55c3bb3',t:'MTc2NzUyMDU0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
