import React, { useState, useEffect } from 'react';
import { Play, Clock, ChevronLeft, RotateCcw, Save, Share2, Info, CheckCircle, Activity, Youtube, History, Star, Trash2, ArrowRight, Check } from 'lucide-react';

/**
 * MOCK DATABASE
 * MVPç”¨ã«ä¸»è¦ãªãƒ‰ãƒªãƒ«ã‚’å†…éƒ¨å®šç¾©
 */
const DRILL_DB = [
  // Warmup
  { id: 'w01', title: 'ãƒ–ãƒ©ã‚¸ãƒ«ä½“æ“', category: 'warmup', intensity: 2, tags: ['warmup'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒ–ãƒ©ã‚¸ãƒ«ä½“æ“' },
  { id: 'w02', title: 'é¬¼ã”ã£ã“ (æ‰‹ã¤ãªã)', category: 'warmup', intensity: 3, tags: ['warmup', 'fun'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒƒãƒ— é¬¼ã”ã£ã“' },
  { id: 'w03', title: 'ãƒ‘ã‚¹ï¼†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å¯¾é¢)', category: 'warmup', intensity: 2, tags: ['warmup', 'pass'], query: 'ã‚µãƒƒã‚«ãƒ¼ å¯¾é¢ãƒ‘ã‚¹ åŸºç¤' },
  { id: 'w04', title: 'ãƒ­ãƒ³ãƒ‰ (4vs1)', category: 'warmup', intensity: 3, tags: ['warmup', 'possession'], query: 'ã‚µãƒƒã‚«ãƒ¼ 4å¯¾1 ãƒ­ãƒ³ãƒ‰' },

  // Fundamental (åŸºç¤)
  { id: 'f01', title: 'ãƒ‰ãƒªãƒ–ãƒ«é€šé (ã‚³ãƒ¼ãƒ³)', category: 'fundamental', intensity: 3, tags: ['dribble'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚³ãƒ¼ãƒ³ãƒ‰ãƒªãƒ–ãƒ« ç·´ç¿’' },
  { id: 'f02', title: 'å¯¾é¢ãƒ­ãƒ³ã‚°ã‚­ãƒƒã‚¯', category: 'fundamental', intensity: 3, tags: ['pass', 'kick'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒ­ãƒ³ã‚°ã‚­ãƒƒã‚¯ ç·´ç¿’' },
  { id: 'f03', title: 'ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°åŸºç¤', category: 'fundamental', intensity: 3, tags: ['physical'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒ˜ãƒ‡ã‚£ãƒ³ã‚° ç·´ç¿’' },
  { id: 'f04', title: '1å¯¾1 ãƒœãƒ¼ãƒ«ã‚­ãƒ¼ãƒ—', category: 'fundamental', intensity: 4, tags: ['dribble', 'physical'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒœãƒ¼ãƒ«ã‚­ãƒ¼ãƒ— ç·´ç¿’' },

  // Main Training (ãƒ†ãƒ¼ãƒåˆ¥)
  { id: 'm01', title: '3vs2 çªç ´ã®å´©ã—', category: 'main', intensity: 4, tags: ['pass', 'tactics'], query: 'ã‚µãƒƒã‚«ãƒ¼ 3å¯¾2 å´©ã—' },
  { id: 'm02', title: '4vs4 + 2ã‚µãƒ¼ãƒãƒ¼', category: 'main', intensity: 4, tags: ['pass', 'possession'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ 4å¯¾4' },
  { id: 'm03', title: 'ã‚·ãƒ¥ãƒ¼ãƒˆã‚²ãƒ¼ãƒ  (GKã‚ã‚Š)', category: 'main', intensity: 4, tags: ['shoot'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚·ãƒ¥ãƒ¼ãƒˆç·´ç¿’ ã‚²ãƒ¼ãƒ å½¢å¼' },
  { id: 'm04', title: 'ã‚¯ãƒ­ã‚¹ã‹ã‚‰ã®ã‚·ãƒ¥ãƒ¼ãƒˆ', category: 'main', intensity: 4, tags: ['shoot', 'pass'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚¯ãƒ­ã‚¹ ã‚·ãƒ¥ãƒ¼ãƒˆç·´ç¿’' },
  { id: 'm05', title: 'ãƒ©ã‚¤ãƒ³çªç ´ 1vs1', category: 'main', intensity: 5, tags: ['dribble', 'defense'], query: 'ã‚µãƒƒã‚«ãƒ¼ 1å¯¾1 çªç ´' },
  { id: 'm06', title: 'å®ˆå‚™ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼†ã‚«ãƒãƒ¼', category: 'main', intensity: 4, tags: ['defense', 'tactics'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ã‚¢ãƒ³ãƒ‰ ã‚«ãƒãƒ¼' },
  { id: 'm07', title: 'ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ (æ”»å®ˆåˆ‡æ›¿)', category: 'main', intensity: 5, tags: ['transition', 'tactics'], query: 'ã‚µãƒƒã‚«ãƒ¼ ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ ç·´ç¿’' },

  // Game
  { id: 'g01', title: 'ãƒãƒ¼ãƒ•ã‚³ãƒ¼ãƒˆã‚²ãƒ¼ãƒ ', category: 'game', intensity: 5, tags: ['game'], query: 'ã‚µãƒƒã‚«ãƒ¼ ç´…ç™½æˆ¦ ãƒãƒ¼ãƒ•ã‚³ãƒ¼ãƒˆ' },
  { id: 'g02', title: 'æ¡ä»¶ä»˜ãã‚²ãƒ¼ãƒ  (ã‚¿ãƒƒãƒåˆ¶é™)', category: 'game', intensity: 4, tags: ['game'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚²ãƒ¼ãƒ å½¢å¼ ã‚¿ãƒƒãƒåˆ¶é™' },
  { id: 'g03', title: '3ãƒãƒ¼ãƒ å›ã— ã‚²ãƒ¼ãƒ ', category: 'game', intensity: 5, tags: ['game'], query: 'ã‚µãƒƒã‚«ãƒ¼ 3ãƒãƒ¼ãƒ å›ã— ã‚²ãƒ¼ãƒ ' },

  // Cooldown
  { id: 'c01', title: 'ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ ã‚¹ãƒˆãƒ¬ãƒƒãƒ', category: 'cooldown', intensity: 1, tags: ['cooldown'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ ã‚¹ãƒˆãƒ¬ãƒƒãƒ' },
  { id: 'c02', title: 'ã‚¸ãƒ§ã‚° & ä¼šè©±', category: 'cooldown', intensity: 1, tags: ['cooldown'], query: 'ã‚µãƒƒã‚«ãƒ¼ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ ã‚¸ãƒ§ã‚°' },
];

/**
 * LOGIC ENGINE
 * æ™‚é–“é…åˆ†ã¨ãƒ‰ãƒªãƒ«é¸å®šã‚’è¡Œã†ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
 */
const generateMenu = (totalTime, intensity, selectedThemes) => {
  // 1. æ™‚é–“é…åˆ†è¨ˆç®— (åˆ†)
  // W-Up: 15%, Fundamental: 20%, Main: 40%, Game: 20%, Cool: 5%
  let timeAlloc = {
    warmup: Math.floor(totalTime * 0.15),
    fundamental: Math.floor(totalTime * 0.20),
    main: Math.floor(totalTime * 0.40),
    game: Math.floor(totalTime * 0.20),
    cooldown: Math.floor(totalTime * 0.05),
  };

  // ç«¯æ•°èª¿æ•´ (åˆè¨ˆãŒtotalTimeã«ãªã‚‹ã‚ˆã†ã«Mainã§èª¿æ•´)
  const currentTotal = Object.values(timeAlloc).reduce((a, b) => a + b, 0);
  timeAlloc.main += (totalTime - currentTotal);

  // 2. ãƒ‰ãƒªãƒ«é¸å®šãƒ˜ãƒ«ãƒ‘ãƒ¼
  const pickDrill = (category, duration, themes = []) => {
    let candidates = DRILL_DB.filter(d => d.category === category);
    
    // ãƒ†ãƒ¼ãƒã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (Mainã®ã¿)
    if (category === 'main' && themes.length > 0) {
      const themeCandidates = candidates.filter(d => 
        d.tags.some(tag => themes.includes(tag))
      );
      if (themeCandidates.length > 0) candidates = themeCandidates;
    }

    // å¼·åº¦ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (ç°¡æ˜“: ãƒ©ãƒ³ãƒ€ãƒ )
    const randomDrill = candidates[Math.floor(Math.random() * candidates.length)];
    
    return {
      ...randomDrill,
      duration: duration
    };
  };

  // 3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰
  return [
    { section: 'W-Up', ...pickDrill('warmup', timeAlloc.warmup) },
    { section: 'Fund.', ...pickDrill('fundamental', timeAlloc.fundamental) },
    { section: 'Main', ...pickDrill('main', timeAlloc.main, selectedThemes) },
    { section: 'Game', ...pickDrill('game', timeAlloc.game) },
    { section: 'Cool', ...pickDrill('cooldown', timeAlloc.cooldown) },
  ];
};

/**
 * UTILS
 */
const formatDate = (isoString) => {
  if (!isoString) return '';
  const date = new Date(isoString);
  return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
};

/**
 * MAIN APP COMPONENT
 */
export default function TactixAI() {
  const [screen, setScreen] = useState('home'); // home, setup, result, detail, history, favorites
  
  // Settings State
  const [conditions, setConditions] = useState({
    time: 90,
    intensity: 2, // 1:Low, 2:Mid, 3:High
    themes: ['pass', 'shoot'],
  });

  // Data State
  const [currentMenu, setCurrentMenu] = useState(null); // { id, date, conditions, items }
  const [selectedDrill, setSelectedDrill] = useState(null);
  
  // Persistent State
  const [history, setHistory] = useState([]);
  const [favorites, setFavorites] = useState([]);
  
  // UI Feedback State
  const [showToast, setShowToast] = useState({ visible: false, message: '' });

  // Initialize Data from LocalStorage
  useEffect(() => {
    const savedHistory = localStorage.getItem('tactix_history');
    const savedFavorites = localStorage.getItem('tactix_favorites');
    if (savedHistory) setHistory(JSON.parse(savedHistory));
    if (savedFavorites) setFavorites(JSON.parse(savedFavorites));
  }, []);

  // Persist Data
  useEffect(() => {
    localStorage.setItem('tactix_history', JSON.stringify(history));
  }, [history]);

  useEffect(() => {
    localStorage.setItem('tactix_favorites', JSON.stringify(favorites));
  }, [favorites]);

  // Toast Helper
  const triggerToast = (msg) => {
    setShowToast({ visible: true, message: msg });
    setTimeout(() => setShowToast({ visible: false, message: '' }), 2000);
  };

  // --- ACTIONS ---

  const handleGenerate = () => {
    const menuItems = generateMenu(conditions.time, conditions.intensity, conditions.themes);
    const newMenu = {
      id: Date.now().toString(),
      date: new Date().toISOString(),
      conditions: { ...conditions },
      items: menuItems
    };
    
    setCurrentMenu(newMenu);
    
    // Add to history (Max 20 items)
    setHistory(prev => [newMenu, ...prev].slice(0, 20));
    
    setScreen('result');
  };

  const handleLoadMenu = (menu) => {
    setCurrentMenu(menu);
    setConditions(menu.conditions); // Restore conditions for consistency
    setScreen('result');
  };

  const toggleFavorite = () => {
    if (!currentMenu) return;

    const isFav = favorites.some(f => f.id === currentMenu.id);
    if (isFav) {
      setFavorites(prev => prev.filter(f => f.id !== currentMenu.id));
      triggerToast('ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ');
    } else {
      setFavorites(prev => [currentMenu, ...prev]);
      triggerToast('ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜ã—ã¾ã—ãŸï¼');
    }
  };

  const deleteFavorite = (e, id) => {
    e.stopPropagation();
    setFavorites(prev => prev.filter(f => f.id !== id));
    triggerToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  const handleShare = () => {
    if (!currentMenu) return;
    const text = [
      `âš½ TactixAI Practice Menu`,
      `ğŸ“… ${formatDate(currentMenu.date)}`,
      `â± ${currentMenu.conditions.time}min | ğŸ”¥ Lv.${currentMenu.conditions.intensity}`,
      '',
      ...currentMenu.items.map(item => `ãƒ»[${item.section}] ${item.title} (${item.duration}m)`),
      '',
      '#TactixAI'
    ].join('\n');

    // navigator.clipboard.writeText is restricted in some iframe environments
    // Fallback to execCommand
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed'; // Avoid scrolling to bottom
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        triggerToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      } else {
        triggerToast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
    } catch (err) {
      console.error('Copy failed', err);
      triggerToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
    
    document.body.removeChild(textarea);
  };

  // --- SCREENS ---

  // 1. HOME
  const renderHome = () => (
    <div className="flex flex-col h-full justify-center items-center p-6 space-y-8 animate-in fade-in">
      <div className="text-center space-y-2">
        <h1 className="text-5xl font-black tracking-tighter text-white italic">
          TACTIX<span className="text-green-400">AI</span>
        </h1>
        <p className="text-gray-400 text-sm">3åˆ†ã§ã€å‹åˆ©ã¸ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ã€‚</p>
      </div>

      <button 
        onClick={() => setScreen('setup')}
        className="w-full py-6 bg-green-500 hover:bg-green-400 text-black font-bold text-xl rounded-2xl shadow-lg shadow-green-500/20 active:scale-95 transition-all flex items-center justify-center gap-3"
      >
        <Activity size={28} />
        æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ
      </button>

      <div className="grid grid-cols-2 gap-4 w-full">
        <button 
          onClick={() => setScreen('history')}
          className="p-4 bg-slate-800 rounded-xl text-gray-400 font-medium hover:bg-slate-700 hover:text-white transition-colors flex flex-col items-center gap-2"
        >
          <History size={24} />
          <span>éå»ã®å±¥æ­´</span>
        </button>
        <button 
          onClick={() => setScreen('favorites')}
          className="p-4 bg-slate-800 rounded-xl text-gray-400 font-medium hover:bg-slate-700 hover:text-white transition-colors flex flex-col items-center gap-2"
        >
          <Star size={24} />
          <span>ãŠæ°—ã«å…¥ã‚Š</span>
        </button>
      </div>
    </div>
  );

  // 2. SETUP
  const renderSetup = () => (
    <div className="flex flex-col h-full p-4 animate-in slide-in-from-right-10">
      <header className="flex items-center mb-6">
        <button onClick={() => setScreen('home')} className="p-2 -ml-2 text-gray-400 hover:text-white">
          <ChevronLeft size={32} />
        </button>
        <h2 className="text-xl font-bold ml-2">æ¡ä»¶è¨­å®š</h2>
      </header>

      <div className="flex-1 space-y-8 overflow-y-auto pb-20">
        {/* TIME */}
        <section>
          <label className="text-gray-400 text-sm font-bold uppercase tracking-wider mb-3 block">ç·´ç¿’æ™‚é–“ (åˆ†)</label>
          <div className="flex items-center justify-between bg-slate-800 p-2 rounded-2xl">
            <button onClick={() => setConditions(p => ({...p, time: Math.max(30, p.time - 10)}))} className="w-16 h-16 bg-slate-700 rounded-xl flex items-center justify-center text-3xl font-bold text-green-400 active:bg-slate-600">-</button>
            <div className="text-5xl font-black text-white w-32 text-center">
              {conditions.time}
            </div>
            <button onClick={() => setConditions(p => ({...p, time: Math.min(180, p.time + 10)}))} className="w-16 h-16 bg-slate-700 rounded-xl flex items-center justify-center text-3xl font-bold text-green-400 active:bg-slate-600">+</button>
          </div>
        </section>

        {/* INTENSITY */}
        <section>
          <label className="text-gray-400 text-sm font-bold uppercase tracking-wider mb-3 block">å¼·åº¦</label>
          <div className="grid grid-cols-3 gap-3">
            {[
              { val: 1, label: 'ä½', sub: 'ãƒªã‚«ãƒãƒªãƒ¼' },
              { val: 2, label: 'ä¸­', sub: 'æ¨™æº–' },
              { val: 3, label: 'é«˜', sub: 'è©¦åˆæœŸ' }
            ].map((level) => (
              <button
                key={level.val}
                onClick={() => setConditions(p => ({ ...p, intensity: level.val }))}
                className={`p-4 rounded-xl border-2 transition-all ${
                  conditions.intensity === level.val 
                    ? 'border-green-500 bg-green-500/10 text-white' 
                    : 'border-slate-700 bg-slate-800 text-gray-500'
                }`}
              >
                <div className="text-xl font-bold">{level.label}</div>
                <div className="text-xs opacity-70">{level.sub}</div>
              </button>
            ))}
          </div>
        </section>

        {/* THEMES */}
        <section>
          <label className="text-gray-400 text-sm font-bold uppercase tracking-wider mb-3 block">å¼·åŒ–ãƒ†ãƒ¼ãƒ (è¤‡æ•°é¸æŠ)</label>
          <div className="grid grid-cols-2 gap-3">
            {[
              { id: 'pass', label: 'ãƒ‘ã‚¹ãƒ»ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³' },
              { id: 'dribble', label: 'ãƒ‰ãƒªãƒ–ãƒ«ãƒ»çªç ´' },
              { id: 'shoot', label: 'ã‚·ãƒ¥ãƒ¼ãƒˆãƒ»æ±ºå®šåŠ›' },
              { id: 'defense', label: 'å®ˆå‚™ãƒ»ãƒ—ãƒ¬ã‚¹' },
              { id: 'tactics', label: 'æˆ¦è¡“ãƒ»é€£æº' },
              { id: 'physical', label: 'ãƒ•ã‚£ã‚¸ã‚«ãƒ«' },
            ].map((theme) => (
              <button
                key={theme.id}
                onClick={() => setConditions(p => {
                  const newThemes = p.themes.includes(theme.id)
                    ? p.themes.filter(t => t !== theme.id)
                    : [...p.themes, theme.id];
                  return { ...p, themes: newThemes };
                })}
                className={`p-4 rounded-xl flex items-center justify-between transition-all ${
                  conditions.themes.includes(theme.id)
                    ? 'bg-green-500 text-black font-bold shadow-lg shadow-green-500/20'
                    : 'bg-slate-800 text-gray-400 hover:bg-slate-700'
                }`}
              >
                <span>{theme.label}</span>
                {conditions.themes.includes(theme.id) && <CheckCircle size={18} />}
              </button>
            ))}
          </div>
        </section>
      </div>

      <div className="fixed bottom-6 left-4 right-4">
        <button 
          onClick={handleGenerate}
          disabled={conditions.themes.length === 0}
          className="w-full py-5 bg-white text-black font-bold text-xl rounded-2xl shadow-xl active:scale-95 disabled:opacity-50 disabled:scale-100 transition-all flex items-center justify-center gap-2"
        >
          <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹</span>
          <Play size={20} fill="currentColor" />
        </button>
      </div>
    </div>
  );

  // 3. RESULT
  const renderResult = () => {
    if (!currentMenu) return null;
    const isFav = favorites.some(f => f.id === currentMenu.id);

    return (
      <div className="flex flex-col h-full bg-slate-950 animate-in slide-in-from-right-10">
        {/* HEADER */}
        <div className="bg-slate-900 p-4 pb-6 rounded-b-3xl shadow-2xl z-10">
          <div className="flex items-center justify-between mb-4">
            <button onClick={() => setScreen('setup')} className="text-gray-400 flex items-center gap-1 hover:text-white">
              <ChevronLeft size={20} /> æ¡ä»¶ä¿®æ­£
            </button>
            <div className="flex gap-3">
              <button 
                onClick={toggleFavorite}
                className={`p-2 rounded-full transition-colors ${isFav ? 'bg-yellow-500/20 text-yellow-400' : 'bg-slate-800 text-gray-400'}`}
              >
                <Save size={20} fill={isFav ? "currentColor" : "none"} />
              </button>
              <button onClick={handleShare} className="p-2 bg-slate-800 rounded-full text-gray-400 hover:text-white transition-colors">
                <Share2 size={20} />
              </button>
            </div>
          </div>
          <div className="flex items-end justify-between">
            <div>
              <h2 className="text-3xl font-black text-white italic tracking-wide">TODAY'S PLAN</h2>
              <div className="flex items-center gap-4 text-sm text-gray-400 mt-1">
                <span className="flex items-center gap-1"><Clock size={14} className="text-green-400"/> {currentMenu.conditions.time}åˆ†</span>
                <span className="flex items-center gap-1"><Activity size={14} className="text-green-400"/> Lv.{currentMenu.conditions.intensity}</span>
              </div>
            </div>
            <button 
              onClick={handleGenerate}
              className="flex flex-col items-center gap-1 text-xs text-green-400 active:opacity-70 hover:scale-105 transition-transform"
            >
              <RotateCcw size={24} />
              <span className="font-bold">å†ç”Ÿæˆ</span>
            </button>
          </div>
        </div>

        {/* LIST */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {currentMenu.items.map((item, index) => (
            <div 
              key={index}
              onClick={() => { setSelectedDrill(item); setScreen('detail'); }}
              className="group relative flex bg-slate-900 rounded-xl overflow-hidden active:scale-[0.98] transition-transform cursor-pointer border border-slate-800 hover:border-green-500/50"
            >
              <div className={`w-2 ${
                item.section === 'W-Up' ? 'bg-yellow-500' :
                item.section === 'Main' ? 'bg-green-500' :
                item.section === 'Game' ? 'bg-red-500' :
                'bg-blue-500'
              }`} />
              
              <div className="flex-1 p-4 flex flex-col justify-between">
                <div className="flex justify-between items-start mb-2">
                  <span className={`text-xs font-bold px-2 py-0.5 rounded uppercase ${
                    item.section === 'W-Up' ? 'bg-yellow-500/20 text-yellow-400' :
                    item.section === 'Main' ? 'bg-green-500/20 text-green-400' :
                    item.section === 'Game' ? 'bg-red-500/20 text-red-400' :
                    'bg-blue-500/20 text-blue-400'
                  }`}>
                    {item.section}
                  </span>
                  <span className="text-xl font-black text-white font-mono">{item.duration}m</span>
                </div>
                <h3 className="text-lg font-bold text-gray-100 leading-tight">{item.title}</h3>
                <div className="mt-2 flex items-center text-xs text-gray-500 gap-2">
                  <Youtube size={14} />
                  <span>è§£èª¬å‹•ç”»ã‚’è¦‹ã‚‹</span>
                </div>
              </div>
              <div className="w-8 flex items-center justify-center text-gray-600">
                <ChevronLeft size={20} className="rotate-180" />
              </div>
            </div>
          ))}
          <div className="text-center py-4 text-gray-600 text-sm">
            Plan generated by TactixAI
          </div>
        </div>
      </div>
    );
  };

  // 4. DETAIL
  const renderDetail = () => {
    if (!selectedDrill) return null;
    const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(selectedDrill.query)}`;

    return (
      <div className="fixed inset-0 bg-slate-950 z-50 flex flex-col animate-in slide-in-from-bottom-20">
        <div className="p-4 flex items-center justify-between border-b border-slate-800">
          <button onClick={() => setScreen('result')} className="p-2 -ml-2 text-white flex items-center gap-2">
            <ChevronLeft size={24} />
            <span className="font-bold">æˆ»ã‚‹</span>
          </button>
          <div className="font-mono text-green-400 font-bold">{selectedDrill.duration} min</div>
        </div>

        <div className="flex-1 overflow-y-auto">
          <div className="bg-slate-900 aspect-video flex items-center justify-center border-b border-slate-800 relative overflow-hidden group">
            <div className="absolute inset-4 border-2 border-slate-700 opacity-50 rounded" />
            <div className="absolute inset-0 flex items-center justify-center">
               <span className="text-slate-600 font-bold text-lg">DRILL DIAGRAM AREA</span>
            </div>
            <a 
              href={searchUrl} 
              target="_blank" 
              rel="noopener noreferrer"
              className="absolute inset-0 bg-black/40 flex items-center justify-center group-hover:bg-black/50 transition-colors"
            >
              <div className="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition-transform">
                <Play size={32} fill="white" className="text-white ml-1" />
              </div>
            </a>
          </div>

          <div className="p-6 space-y-6">
            <div>
              <div className="flex gap-2 mb-2">
                {selectedDrill.tags.map(tag => (
                  <span key={tag} className="text-xs font-bold text-gray-500 bg-slate-900 px-2 py-1 rounded">
                    #{tag}
                  </span>
                ))}
              </div>
              <h2 className="text-2xl font-bold text-white mb-2">{selectedDrill.title}</h2>
              <p className="text-gray-400 leading-relaxed">
                ã“ã®ç·´ç¿’ã¯{selectedDrill.category === 'main' ? 'è©¦åˆã§ã®å®Ÿæˆ¦çš„ãªå‹•ã' : 'åŸºç¤çš„ãªæŠ€è¡“'}ã‚’é¤Šã†ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
                å¼·åº¦ãƒ¬ãƒ™ãƒ«{selectedDrill.intensity}ã§å®Ÿæ–½ã—ã€{selectedDrill.duration}åˆ†é–“ã§é›†ä¸­ã—ã¦è¡Œã„ã¾ã™ã€‚
              </p>
            </div>
            <div className="bg-slate-900 p-5 rounded-xl border border-slate-800">
              <h3 className="text-green-400 font-bold mb-3 flex items-center gap-2">
                <Info size={18} />
                COACHING POINTS
              </h3>
              <ul className="space-y-3">
                <li className="flex gap-3 text-gray-300">
                  <span className="text-green-500 font-bold">1.</span>
                  <span>ãƒœãƒ¼ãƒ«ã®ç§»å‹•ä¸­ã«æ¬¡ã®ãƒ—ãƒ¬ãƒ¼ã‚’è€ƒãˆã‚‹</span>
                </li>
                <li className="flex gap-3 text-gray-300">
                  <span className="text-green-500 font-bold">2.</span>
                  <span>ãƒŸã‚¹ã‚’æã‚Œãšã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è¿½æ±‚ã™ã‚‹</span>
                </li>
              </ul>
            </div>
            <a 
              href={searchUrl} 
              target="_blank" 
              rel="noopener noreferrer"
              className="block w-full py-4 bg-red-600 text-white font-bold text-center rounded-xl shadow-lg shadow-red-900/20 active:scale-95 transition-transform flex items-center justify-center gap-2"
            >
              <Youtube size={24} />
              YouTubeã§è§£èª¬å‹•ç”»ã‚’æ¢ã™
            </a>
          </div>
        </div>
      </div>
    );
  };

  // 5. HISTORY / FAVORITES LIST
  const renderListScreen = (type) => {
    const isHistory = type === 'history';
    const data = isHistory ? history : favorites;
    const title = isHistory ? 'éå»ã®å±¥æ­´' : 'ãŠæ°—ã«å…¥ã‚Š';
    const EmptyIcon = isHistory ? History : Star;

    return (
      <div className="flex flex-col h-full p-4 animate-in slide-in-from-right-10">
        <header className="flex items-center mb-6">
          <button onClick={() => setScreen('home')} className="p-2 -ml-2 text-gray-400 hover:text-white">
            <ChevronLeft size={32} />
          </button>
          <h2 className="text-xl font-bold ml-2">{title}</h2>
        </header>

        {data.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center text-gray-600 gap-4">
            <EmptyIcon size={48} className="opacity-50" />
            <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        ) : (
          <div className="flex-1 overflow-y-auto space-y-3 pb-20">
            {data.map((menu) => (
              <div 
                key={menu.id} 
                onClick={() => handleLoadMenu(menu)}
                className="bg-slate-900 p-4 rounded-xl border border-slate-800 hover:border-green-500/50 active:scale-[0.98] transition-all cursor-pointer flex justify-between items-center group"
              >
                <div>
                  <div className="text-xs text-green-400 font-bold mb-1">{formatDate(menu.date)}</div>
                  <div className="text-white font-bold mb-1">
                     {menu.conditions.time}åˆ†ã‚³ãƒ¼ã‚¹ / å¼·åº¦: {menu.conditions.intensity}
                  </div>
                  <div className="text-xs text-gray-500 truncate max-w-[200px]">
                    Main: {menu.items.find(i => i.section === 'Main')?.title || 'ãŠã¾ã‹ã›'}
                  </div>
                </div>
                
                {/* Actions */}
                <div className="flex items-center gap-2">
                  {!isHistory && (
                    <button 
                      onClick={(e) => deleteFavorite(e, menu.id)}
                      className="p-3 text-gray-500 hover:text-red-400 hover:bg-red-400/10 rounded-full transition-colors"
                    >
                      <Trash2 size={18} />
                    </button>
                  )}
                  <div className="p-2 text-gray-600 group-hover:text-white transition-colors">
                    <ArrowRight size={20} />
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="w-full h-screen bg-slate-950 text-white font-sans overflow-hidden select-none relative">
      <div className="max-w-md mx-auto h-full shadow-2xl relative bg-slate-950 flex flex-col">
        {screen === 'home' && renderHome()}
        {screen === 'setup' && renderSetup()}
        {screen === 'result' && renderResult()}
        {screen === 'detail' && renderDetail()}
        {(screen === 'history' || screen === 'favorites') && renderListScreen(screen)}

        {/* Toast Notification */}
        {showToast.visible && (
          <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold shadow-xl flex items-center gap-2 animate-in fade-in slide-in-from-top-4 z-[100]">
            <Check size={18} className="text-green-600" />
            {showToast.message}
          </div>
        )}
      </div>
    </div>
  );
}
